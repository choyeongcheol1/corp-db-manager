<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}법인 DB 관리 시스템{% endblock %}</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Alpine.js (UI 토글 전용) -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        [x-cloak] { display: none !important; }
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator { display: inline-flex; }
        .htmx-request.htmx-indicator { display: inline-flex; }
        
        /* ── HTMX 페이지 전환: 콘텐츠 영역 fade-in ── */
        #page-content {
            animation: mainFadeIn 0.15s ease-out;
        }
        @keyframes mainFadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }
        /* HTMX 요청 중 콘텐츠 영역만 살짝 흐리게 */
        #page-content.htmx-request {
            pointer-events: none;
            opacity: 0.6;
            transition: opacity 0.1s;
        }
    </style>
    
    {% block head %}{% endblock %}
</head>
<body class="bg-gray-50 min-h-screen">
    {% from "components/icons.html" import svg_icon %}
    
    {% block body %}
    <div class="flex h-screen" x-data="{ sidebarOpen: true }">
        
        <!-- 사이드바 -->
        {% if user %}
        <aside class="bg-primary-900 text-white transition-all duration-300 flex flex-col flex-shrink-0"
            :class="sidebarOpen ? 'w-64' : 'w-20'">
            
            <!-- 로고 (고정) -->
            <div class="p-4 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary-700 rounded-lg flex items-center justify-center flex-shrink-0">
                        {{ svg_icon('building', 'w-6 h-6') }}
                    </div>
                    <span class="font-bold text-lg" x-show="sidebarOpen" x-cloak>DB 관리 시스템</span>
                </div>
            </div>
            
            <!-- 메뉴 (스크롤 가능) -->
            <nav class="flex-1 overflow-y-auto min-h-0 px-4 pb-4 space-y-2">
                {% include "components/sidebar_menu.html" %}
            </nav>
            
            <!-- 사용자 정보 (하단 고정) -->
            <div class="flex-shrink-0 p-4 border-t border-primary-800">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-primary-700 flex items-center justify-center flex-shrink-0">
                        {{ svg_icon('user', 'w-5 h-5') }}
                    </div>
                    <div x-show="sidebarOpen" x-cloak>
                        <div class="text-sm font-medium">{{ user.name }}</div>
                        <div class="text-xs text-primary-300">{{ user.role }}</div>
                    </div>
                </div>
            </div>
        </aside>
        {% endif %}
        
        <!-- ★ 메인 컨텐츠 래퍼 (HTMX 교체 대상) -->
        <div id="main-content" class="flex-1 flex flex-col overflow-hidden">
            
            <!-- 상단 헤더 -->
            {% if user %}
            <header class="bg-white border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <!-- 사이드바 토글 -->
                        <button @click="sidebarOpen = !sidebarOpen" class="text-gray-500 hover:text-gray-700">
                            {{ svg_icon('bars-3', 'w-6 h-6') }}
                        </button>
                        
                        <!-- 서버 선택 드롭다운 -->
                        {% block server_selector %}{% endblock %}
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <!-- 도움말 -->
                        <a href="/static/docs/법인db관리시스템설명서.html" target="_blank" 
                           class="flex items-center gap-1.5 text-gray-500 hover:text-primary-600 transition-colors"
                           title="제품 설명서">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            <span class="text-sm hidden sm:inline">도움말</span>
                        </a>
                        
                        <!-- 알림 -->
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" 
                                    class="relative text-gray-500 hover:text-gray-700 p-1"
                                    :class="{ 'text-gray-700': open }">
                                {{ svg_icon('bell', 'w-6 h-6') }}
                                <!-- 알림 배지 (HTMX로 30초마다 폴링) -->
                                <span id="notification-badge"
                                    hx-get="/notifications/badge"
                                    hx-trigger="load, every 30s"
                                    hx-swap="innerHTML">
                                </span>
                            </button>
                            
                            <!-- 알림 드롭다운 -->
                            <div x-show="open" 
                                x-cloak
                                @click.outside="open = false"
                                x-transition:enter="transition ease-out duration-100"
                                x-transition:enter-start="transform opacity-0 scale-95"
                                x-transition:enter-end="transform opacity-100 scale-100"
                                x-transition:leave="transition ease-in duration-75"
                                x-transition:leave-start="transform opacity-100 scale-100"
                                x-transition:leave-end="transform opacity-0 scale-95"
                                class="absolute right-0 mt-2 z-50">
                                <div id="notification-content"
                                    hx-get="/notifications"
                                    hx-trigger="intersect once"
                                    hx-swap="innerHTML">
                                    <!-- 로딩 -->
                                    <div class="w-80 bg-white rounded-xl shadow-xl border border-gray-200 p-8 text-center">
                                        <div class="animate-spin w-6 h-6 border-2 border-primary-600 border-t-transparent rounded-full mx-auto"></div>
                                        <p class="text-sm text-gray-500 mt-2">로딩 중...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 로그아웃 -->
                        <a href="/auth/logout" class="flex items-center gap-1.5 text-gray-500 hover:text-red-600 transition-colors text-sm">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                <polyline points="16 17 21 12 16 7"/>
                                <line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                            <span class="hidden sm:inline">로그아웃</span>
                        </a>
                    </div>
                </div>
            </header>
            {% endif %}
            
            <!-- ★ 페이지 컨텐츠 (HTMX 교체 대상) -->
            <main id="page-content" class="flex-1 overflow-y-auto p-6">
                <div class="max-w-7xl mx-auto">
                    {% block content %}{% endblock %}
                </div>
                {# ── 페이지별 스크립트: page-content 안에 포함되어 HTMX 교체 시 자동 실행 ── #}
                {% block scripts %}{% endblock %}
            </main>
            
            <!-- 푸터 (하단 고정) -->
            {% if user %}
            <footer class="bg-gray-50 border-t border-gray-200 py-3 text-center flex-shrink-0">
                <p class="text-xs text-gray-400">© 2026 Corp DB Manager v1.1.0</p>
            </footer>
            {% endif %}
        </div>
    </div>
    {% endblock %}
    
    <!-- 토스트 알림 -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    
    <script>
        document.body.addEventListener('htmx:responseError', function(evt) {
            showToast('오류가 발생했습니다', 'error');
        });
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const colors = {
                info: 'bg-blue-500',
                success: 'bg-green-500',
                warning: 'bg-yellow-500',
                error: 'bg-red-500'
            };
            
            const toast = document.createElement('div');
            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 10);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // ── HTMX SPA: 페이지 전환 시 Script 실행 + Alpine.js 재초기화 ──
        // hx-select + outerHTML 사용 시 <script> 태그가 실행되지 않으므로
        // beforeSwap에서 미리 추출 → afterSettle에서 실행 + Alpine 초기화
        
        var _pendingScripts = [];  // beforeSwap에서 추출한 script 코드 보관
        
        // (A) 응답 HTML에서 script 코드를 미리 추출
        document.body.addEventListener('htmx:beforeSwap', function(evt) {
            _pendingScripts = [];
            var serverResponse = evt.detail.serverResponse;
            if (!serverResponse || typeof serverResponse !== 'string') return;
            
            // 응답 전체에서 #page-content 내부의 <script> 태그 추출
            var parser = new DOMParser();
            var doc = parser.parseFromString(serverResponse, 'text/html');
            var pageContent = doc.getElementById('page-content');
            if (pageContent) {
                var scripts = pageContent.querySelectorAll('script');
                for (var i = 0; i < scripts.length; i++) {
                    if (scripts[i].textContent && scripts[i].textContent.trim()) {
                        _pendingScripts.push(scripts[i].textContent);
                    }
                }
            }
        });
        
        // (B) DOM 교체 완료 후 script 실행 + Alpine 재초기화
        // ※ afterSettle 사용 — outerHTML 교체가 완전히 끝난 후 실행됨
        document.body.addEventListener('htmx:afterSettle', function(evt) {
            // outerHTML swap 시 evt.detail.target은 교체 전 요소이므로
            // 새로 삽입된 #page-content를 DOM에서 직접 조회
            var newTarget = document.getElementById('page-content');
            if (!newTarget) return;
            
            // page-content 교체인지 확인 (다른 HTMX 요청은 무시)
            var requestPath = evt.detail.pathInfo && evt.detail.pathInfo.requestPath;
            var elt = evt.detail.elt;
            // nav_link에서 온 요청만 처리 (hx-target="#page-content")
            if (!elt || !elt.getAttribute || elt.getAttribute('hx-target') !== '#page-content') {
                // target 자체가 page-content인 경우도 체크
                if (evt.detail.target && evt.detail.target.id !== 'page-content') return;
            }
            
            // 1) 사이드바 active 메뉴 업데이트
            var currentPath = window.location.pathname;
            document.querySelectorAll('[data-nav-link]').forEach(function(link) {
                var paths = link.getAttribute('data-nav-link').split(',');
                var isActive = paths.some(function(p) {
                    return currentPath === p || (p !== '/' && currentPath.startsWith(p));
                });
                if (isActive) {
                    link.classList.add('bg-primary-800');
                    link.classList.remove('hover:bg-primary-800');
                } else {
                    link.classList.remove('bg-primary-800');
                    link.classList.add('hover:bg-primary-800');
                }
            });
            
            // 2) 추출해둔 script 실행 (beforeSwap에서 저장)
            for (var i = 0; i < _pendingScripts.length; i++) {
                try {
                    eval(_pendingScripts[i]);
                } catch(e) {
                    console.error('[HTMX] Script 실행 오류:', e);
                }
            }
            
            // 3) 새 DOM 내 script 태그도 실행 (hx-select가 script를 포함했을 경우)
            var inlineScripts = newTarget.querySelectorAll('script');
            for (var j = 0; j < inlineScripts.length; j++) {
                try {
                    if (inlineScripts[j].textContent && inlineScripts[j].textContent.trim()) {
                        // 새 script 엘리먼트로 교체하여 브라우저가 실행하도록 함
                        var oldScript = inlineScripts[j];
                        var newScript = document.createElement('script');
                        newScript.textContent = oldScript.textContent;
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    }
                } catch(e) {
                    console.error('[HTMX] Inline script 실행 오류:', e);
                }
            }
            _pendingScripts = [];
            
            // 4) Alpine.js 재초기화 — microtask로 script 등록 완료 보장
            Promise.resolve().then(function() {
                if (window.Alpine) {
                    newTarget.querySelectorAll('[x-data]').forEach(function(el) {
                        if (el._x_dataStack) {
                            try { Alpine.destroyTree(el); } catch(e) {}
                        }
                    });
                    Alpine.initTree(newTarget);
                }
            });
        });
    </script>
    
</body>
</html>