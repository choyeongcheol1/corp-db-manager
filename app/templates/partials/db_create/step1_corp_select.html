{% from "components/icons.html" import svg_icon %}

<!-- 1단계: 법인 선택 -->
<div class="space-y-6">
    
    <!-- ============================================================ -->
    <!-- 법인 정보 조회 설정 (메인 DB) -->
    <!-- ============================================================ -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="bg-gradient-to-r from-primary-600 to-primary-700 px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                        {{ svg_icon('circle-stack', 'w-5 h-5') }}
                        법인 정보 조회 (메인 DB)
                    </h2>
                    <p class="text-primary-100 text-sm mt-1">법인 정보가 저장된 메인 DB 연결 설정</p>
                </div>
                <button type="button" onclick="loadFromSettings()" 
                        class="px-3 py-1.5 bg-white/20 text-white text-sm rounded-lg hover:bg-white/30 transition flex items-center gap-1">
                    {{ svg_icon('cog-6-tooth', 'w-4 h-4') }}
                    설정에서 불러오기
                </button>
            </div>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <!-- 서버 선택 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">서버 *</label>
                    <select id="main-server" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500 transition text-sm">
                        <option value="">서버 선택</option>
                        {% for server in servers %}
                        <option value="{{ server.id }}">{{ server.server_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- DB명 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">DB명 *</label>
                    <input type="text" id="main-db-name" placeholder="예: ERP_MAIN"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500 transition text-sm">
                </div>
                <!-- 테이블명 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">테이블명 *</label>
                    <input type="text" id="main-table-name" placeholder="예: COMS_CMPNY"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500 transition text-sm">
                </div>
                <!-- 조회 버튼 -->
                <div class="flex items-end">
                    <button type="button" onclick="fetchCorpList()" 
                            class="w-full px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition flex items-center justify-center gap-2 text-sm">
                        {{ svg_icon('magnifying-glass', 'w-4 h-4') }}
                        법인 목록 조회
                    </button>
                </div>
            </div>
            
            <!-- 컬럼 매핑 (접이식) -->
            <details class="border border-gray-200 rounded-lg">
                <summary class="px-4 py-2 bg-gray-50 cursor-pointer text-sm font-medium text-gray-700 hover:bg-gray-100">
                    컬럼 매핑 설정 (클릭하여 펼치기)
                </summary>
                <div class="p-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">법인코드 컬럼</label>
                        <input type="text" id="col-corp-code" value="CORP_CD" 
                               class="w-full px-3 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:border-primary-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">법인명 컬럼</label>
                        <input type="text" id="col-corp-name" value="CORP_NM"
                               class="w-full px-3 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:border-primary-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">사업자번호 컬럼</label>
                        <input type="text" id="col-biz-no" value="SAUPNO"
                               class="w-full px-3 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:border-primary-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">회계DB명 컬럼</label>
                        <input type="text" id="col-acc-db" value="ACC_DB_NAME"
                               class="w-full px-3 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:border-primary-500">
                    </div>
                </div>
            </details>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- 법인 목록 -->
    <!-- ============================================================ -->
    <div id="corp-list-section" class="hidden">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                    {{ svg_icon('building-office-2', 'w-5 h-5 text-primary-600') }}
                    조회된 법인 목록
                    <span id="corp-count" class="text-sm font-normal text-gray-500"></span>
                </h3>
                <div class="flex items-center gap-2">
                    <label class="flex items-center gap-2 text-sm text-gray-600">
                        <input type="checkbox" id="show-only-new" class="rounded text-primary-600" onchange="filterCorpList()">
                        DB 미생성 법인만 표시
                    </label>
                    <input type="text" id="corp-search" placeholder="검색..."
                           class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-primary-500"
                           onkeyup="filterCorpList()">
                </div>
            </div>
            <div id="corp-list-container" class="max-h-64 overflow-y-auto">
                <!-- 법인 목록이 여기에 표시됨 -->
            </div>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- 선택된 신규 법인 정보 (법인 선택 시 표시) -->
    <!-- ============================================================ -->
    <div id="new-corp-info-section" class="hidden">
        <div class="bg-white rounded-xl shadow-sm border border-primary-200 overflow-hidden">
            <div class="px-6 py-3 bg-primary-50 border-b border-primary-100 flex items-center gap-2">
                <span class="text-primary-600">{{ svg_icon('building-office', 'w-5 h-5') }}</span>
                <h3 class="font-semibold text-primary-800">신규 법인 정보</h3>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">법인코드</span>
                        <p id="display-corp-code" class="font-mono font-semibold text-gray-800 mt-0.5">-</p>
                    </div>
                    <div>
                        <span class="text-gray-500">법인명</span>
                        <p id="display-corp-name" class="font-semibold text-gray-800 mt-0.5">-</p>
                    </div>
                    <div>
                        <span class="text-gray-500">사업자번호</span>
                        <p id="display-biz-no" class="text-gray-800 mt-0.5">-</p>
                    </div>
                    <div>
                        <span class="text-gray-500">생성될 DB명</span>
                        <p id="display-db-name" class="font-mono font-semibold text-primary-600 mt-0.5">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- 소스 / 타겟 설정 (2컬럼) -->
    <!-- ============================================================ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- 참조 법인 (소스) -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-blue-500">{{ svg_icon('arrow-up-tray', 'w-5 h-5') }}</span>
                참조 법인 (소스)
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">기존 운영 법인 선택 *</label>
                    <select id="ref-corp-select"
                            onchange="onRefCorpChange(this.value)"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500 transition">
                        <option value="">법인 목록을 먼저 조회하세요</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">DB가 생성된 기존 법인의 스키마와 기초 데이터가 복제됩니다</p>
                </div>
                
                <!-- 참조 DB 정보 (법인 선택 시 표시) -->
                <div id="ref-db-info" class="hidden">
                    <div class="p-3 bg-blue-50 rounded-lg border border-blue-100 space-y-1.5 text-sm">
                        <div class="flex justify-between">
                            <span class="text-blue-600">DB명</span>
                            <span id="ref-db-name" class="font-mono font-medium text-gray-800">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-blue-600">서버</span>
                            <span id="ref-server-name" class="font-medium text-gray-800">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-blue-600">상태</span>
                            <span id="ref-db-status" class="font-medium">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 기존 API 호환용 hidden 필드 -->
            <input type="hidden" id="source-server">
            <input type="hidden" id="source-db">
        </div>
        
        <!-- 생성 대상 (타겟) -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-green-500">{{ svg_icon('arrow-down-tray', 'w-5 h-5') }}</span>
                생성 대상 (타겟)
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">서버 선택 *</label>
                    <select id="target-server" required
                            onchange="checkPreviewReady()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500 transition">
                        <option value="">서버를 선택하세요</option>
                        {% for server in servers %}
                        <option value="{{ server.id }}" {% if server_id == server.id %}selected{% endif %}>{{ server.server_name }}</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-500 mt-1">새 DB가 생성될 서버를 선택합니다</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">생성될 DB명</label>
                    <input type="text" id="target-db-name" readonly
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-600"
                           placeholder="법인 선택 시 자동 입력">
                </div>
            </div>
        </div>
    </div>
    
    <!-- 숨겨진 입력 필드 -->
    <input type="hidden" id="corp-code">
    <input type="hidden" id="corp-name">
    <input type="hidden" id="biz-no">
    <input type="hidden" id="acc-db-name">
    
    <!-- ============================================================ -->
    <!-- 하단 버튼 -->
    <!-- ============================================================ -->
    <div class="flex justify-center gap-4">
        <a href="/servers" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
            취소
        </a>
        <button type="button" onclick="showSqlPreview()" id="preview-btn" disabled
                class="px-8 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition flex items-center gap-2 disabled:bg-gray-300 disabled:cursor-not-allowed">
            {{ svg_icon('document-text', 'w-5 h-5') }}
            SQL 미리보기
        </button>
    </div>
</div>

<script>
// ============================================================
// 설정 불러오기
// ============================================================

function loadFromSettings() {
    fetch('/api/settings/main-db')
        .then(response => response.json())
        .then(data => {
            if (data.main_db_server_id) {
                document.getElementById('main-server').value = data.main_db_server_id;
            }
            document.getElementById('main-db-name').value = data.main_db_name || '';
            document.getElementById('main-table-name').value = data.corp_table_name || 'COMS_CMPNY';
            document.getElementById('col-corp-code').value = data.corp_code_column || 'CORP_CD';
            document.getElementById('col-corp-name').value = data.corp_name_column || 'CORP_NM';
            document.getElementById('col-biz-no').value = data.biz_no_column || 'SAUPNO';
            document.getElementById('col-acc-db').value = data.acc_db_name_column || 'ACC_DB_NAME';
            
            showToast('설정을 불러왔습니다.', 'success');
        })
        .catch(error => {
            showToast('설정 불러오기 실패: ' + error, 'error');
        });
}

// ============================================================
// 법인 목록 조회
// ============================================================

function fetchCorpList() {
    const serverId = document.getElementById('main-server').value;
    const dbName = document.getElementById('main-db-name').value.trim();
    const tableName = document.getElementById('main-table-name').value.trim();
    
    if (!serverId || !dbName || !tableName) {
        alert('서버, DB명, 테이블명을 모두 입력하세요.');
        return;
    }
    
    const columns = {
        corp_code_col: document.getElementById('col-corp-code').value.trim(),
        corp_name_col: document.getElementById('col-corp-name').value.trim(),
        biz_no_col: document.getElementById('col-biz-no').value.trim(),
        acc_db_col: document.getElementById('col-acc-db').value.trim()
    };
    
    document.getElementById('corp-list-section').classList.remove('hidden');
    document.getElementById('corp-list-container').innerHTML = `
        <div class="p-8 text-center">
            <div class="inline-block w-8 h-8 border-4 border-primary-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-gray-500">법인 정보를 조회하는 중...</p>
        </div>
    `;
    
    fetch('/api/corps/fetch-from-main-db', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            server_id: parseInt(serverId),
            db_name: dbName,
            table_name: tableName,
            ...columns
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            document.getElementById('corp-list-container').innerHTML = `
                <div class="p-8 text-center text-red-500">
                    <p>오류: ${data.error}</p>
                </div>
            `;
            return;
        }
        
        corpList = data.corps || [];
        renderCorpList();
        updateRefCorpDropdown();
    })
    .catch(error => {
        document.getElementById('corp-list-container').innerHTML = `
            <div class="p-8 text-center text-red-500">
                <p>조회 실패: ${error}</p>
            </div>
        `;
    });
}

// ============================================================
// 법인 목록 렌더링
// ============================================================

function renderCorpList() {
    const container = document.getElementById('corp-list-container');
    const showOnlyNew = document.getElementById('show-only-new').checked;
    const searchKeyword = document.getElementById('corp-search').value.toLowerCase();
    
    let filteredList = corpList.filter(corp => {
        if (showOnlyNew && corp.has_db) return false;
        if (searchKeyword) {
            const searchText = `${corp.corp_code} ${corp.corp_name} ${corp.biz_no || ''}`.toLowerCase();
            if (!searchText.includes(searchKeyword)) return false;
        }
        return true;
    });
    
    document.getElementById('corp-count').textContent = `(${filteredList.length}/${corpList.length}건)`;
    
    if (filteredList.length === 0) {
        container.innerHTML = `
            <div class="p-8 text-center text-gray-500">
                <p>조건에 맞는 법인이 없습니다.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <table class="w-full text-sm">
            <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm">
                <tr>
                    <th class="px-4 py-3 text-left font-semibold text-gray-700 w-10 bg-gray-100"></th>
                    <th class="px-4 py-3 text-left font-semibold text-gray-700 bg-gray-100">법인코드</th>
                    <th class="px-4 py-3 text-left font-semibold text-gray-700 bg-gray-100">법인명</th>
                    <th class="px-4 py-3 text-left font-semibold text-gray-700 bg-gray-100">사업자번호</th>
                    <th class="px-4 py-3 text-left font-semibold text-gray-700 bg-gray-100">회계DB명</th>
                    <th class="px-4 py-3 text-center font-semibold text-gray-700 bg-gray-100">상태</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                ${filteredList.map((corp, idx) => `
                    <tr class="hover:bg-gray-50 cursor-pointer ${corp.has_db ? 'opacity-50' : ''} ${selectedCorp?.corp_code === corp.corp_code ? 'bg-primary-50' : ''}" 
                        onclick="${corp.has_db ? '' : `selectCorp(${idx})`}">
                        <td class="px-4 py-2">
                            <input type="radio" name="corp-select" value="${idx}" 
                                   ${corp.has_db ? 'disabled' : ''} 
                                   ${selectedCorp?.corp_code === corp.corp_code ? 'checked' : ''}
                                   onchange="selectCorp(${idx})"
                                   class="text-primary-600">
                        </td>
                        <td class="px-4 py-2 font-mono">${corp.corp_code}</td>
                        <td class="px-4 py-2 font-medium">${corp.corp_name}</td>
                        <td class="px-4 py-2 text-gray-600">${corp.biz_no || '-'}</td>
                        <td class="px-4 py-2 font-mono text-gray-600">${corp.acc_db_name || '-'}</td>
                        <td class="px-4 py-2 text-center">
                            ${corp.has_db 
                                ? '<span class="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded">생성됨</span>'
                                : '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded">미생성</span>'
                            }
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function filterCorpList() {
    renderCorpList();
}

// ============================================================
// 법인 선택
// ============================================================

function selectCorp(index) {
    const filteredList = corpList.filter(c => {
        const showOnlyNew = document.getElementById('show-only-new').checked;
        const searchKeyword = document.getElementById('corp-search').value.toLowerCase();
        if (showOnlyNew && c.has_db) return false;
        if (searchKeyword) {
            const searchText = `${c.corp_code} ${c.corp_name} ${c.biz_no || ''}`.toLowerCase();
            if (!searchText.includes(searchKeyword)) return false;
        }
        return true;
    });
    
    const corp = filteredList[index];
    if (!corp || corp.has_db) return;
    
    selectedCorp = corp;
    
    // hidden 필드 설정
    document.getElementById('corp-code').value = corp.corp_code;
    document.getElementById('corp-name').value = corp.corp_name;
    document.getElementById('biz-no').value = corp.biz_no || '';
    document.getElementById('acc-db-name').value = corp.acc_db_name || '';
    document.getElementById('target-db-name').value = corp.acc_db_name || `ACC_${corp.corp_code}`;
    
    // 신규 법인 정보 카드 표시
    document.getElementById('new-corp-info-section').classList.remove('hidden');
    document.getElementById('display-corp-code').textContent = corp.corp_code;
    document.getElementById('display-corp-name').textContent = corp.corp_name;
    document.getElementById('display-biz-no').textContent = corp.biz_no || '-';
    document.getElementById('display-db-name').textContent = corp.acc_db_name || `ACC_${corp.corp_code}`;
    
    // 미리보기 버튼 활성화 체크
    checkPreviewReady();
    renderCorpList();
}

// ============================================================
// 참조 법인 (소스) 드롭다운
// ============================================================

function updateRefCorpDropdown() {
    const select = document.getElementById('ref-corp-select');
    const existingCorps = corpList.filter(c => c.has_db);
    
    select.innerHTML = '<option value="">참조할 법인을 선택하세요</option>';
    existingCorps.forEach((corp, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.textContent = `${corp.corp_code} - ${corp.corp_name} (${corp.acc_db_name || '-'})`;
        select.appendChild(option);
    });
}

function onRefCorpChange(value) {
    const infoDiv = document.getElementById('ref-db-info');
    
    if (!value && value !== 0) {
        infoDiv.classList.add('hidden');
        document.getElementById('source-server').value = '';
        document.getElementById('source-db').value = '';
        checkPreviewReady();
        return;
    }
    
    const existingCorps = corpList.filter(c => c.has_db);
    const corp = existingCorps[parseInt(value)];
    if (!corp) return;
    
    // 참조 DB 정보 표시
    infoDiv.classList.remove('hidden');
    document.getElementById('ref-db-name').textContent = corp.acc_db_name || '-';
    document.getElementById('ref-server-name').textContent = corp.server_name || '(조회 서버)';
    document.getElementById('ref-db-status').innerHTML = 
        '<span class="inline-flex items-center gap-1 text-green-700">' +
        '<span class="w-2 h-2 bg-green-500 rounded-full"></span>운영중</span>';
    
    // hidden 필드 설정 (기존 API 호환)
    // server_id가 있으면 사용, 없으면 메인 서버 ID로 대체
    const serverId = corp.server_id || document.getElementById('main-server').value;
    document.getElementById('source-server').value = serverId;
    document.getElementById('source-db').value = corp.acc_db_name || '';
    
    checkPreviewReady();
}

// ============================================================
// 미리보기 버튼 활성화 조건
// ============================================================

function checkPreviewReady() {
    const corpCode = document.getElementById('corp-code').value;
    const sourceDb = document.getElementById('source-db').value;
    const targetServer = document.getElementById('target-server').value;
    
    const ready = !!(corpCode && sourceDb && targetServer);
    document.getElementById('preview-btn').disabled = !ready;
}

// ============================================================
// SQL 미리보기
// ============================================================

function showSqlPreview() {
    const sourceServer = document.getElementById('source-server').value;
    const sourceDb = document.getElementById('source-db').value;
    const targetServer = document.getElementById('target-server').value;
    const corpCode = document.getElementById('corp-code').value;
    const corpName = document.getElementById('corp-name').value;
    const bizNo = document.getElementById('biz-no').value;
    const accDbName = document.getElementById('acc-db-name').value;
    
    if (!sourceServer || !sourceDb) {
        alert('참조 법인을 선택하세요.');
        return;
    }
    if (!targetServer) {
        alert('대상 서버를 선택하세요.');
        return;
    }
    if (!corpCode || !corpName) {
        alert('법인을 선택하세요.');
        return;
    }
    
    const requestBody = {
        source_server_id: parseInt(sourceServer),
        source_db_name: sourceDb,
        target_server_id: parseInt(targetServer),
        corp_code: corpCode,
        corp_name: corpName,
        biz_no: bizNo,
        acc_db_name: accDbName
    };
    
    if (replicationSettings) {
        requestBody.db_data_path = replicationSettings.db_data_path;
        requestBody.db_log_path = replicationSettings.db_log_path;
        requestBody.initial_db_size_mb = replicationSettings.initial_db_size_mb;
        requestBody.initial_log_size_mb = replicationSettings.initial_log_size_mb;
        requestBody.file_growth_mb = replicationSettings.file_growth_mb;
    }
    
    fetch('/partials/corps/generate-sql', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('오류: ' + data.error);
            return;
        }
        
        document.getElementById('sql-editor').value = data.sql;
        document.getElementById('sql-summary').innerHTML = `
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="text-blue-600">소스 DB:</span>
                    <span class="font-medium">${data.source_db}</span>
                </div>
                <div>
                    <span class="text-blue-600">대상 DB:</span>
                    <span class="font-medium">${data.target_db}</span>
                </div>
                <div>
                    <span class="text-blue-600">법인:</span>
                    <span class="font-medium">${data.corp_code} ${corpName}</span>
                </div>
                <div>
                    <span class="text-blue-600">대상 서버:</span>
                    <span class="font-medium">${document.getElementById('target-server').selectedOptions[0]?.text || '-'}</span>
                </div>
            </div>
        `;
        
        goToStep2();
    })
    .catch(error => {
        alert('SQL 생성 중 오류가 발생했습니다: ' + error);
    });
}
</script>