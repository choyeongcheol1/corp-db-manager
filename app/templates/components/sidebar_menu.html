{% from "components/icons.html" import svg_icon %}
{% set current_path = request.url.path %}
{% set is_admin = user and user.role == 'admin' %}
{% set sid = '/' + server_id|string if server_id else '' %}
{% set has_server = server_id is defined and server_id %}

{# ── HTMX 네비게이션 매크로 ──
   hx-get:      AJAX로 페이지 요청
   hx-target:   #page-content 교체
   hx-select:   서버 응답에서 #page-content만 추출
   hx-swap:     outerHTML로 전체 교체 (id 유지)
   hx-push-url: 브라우저 URL 변경 (뒤로가기 지원)
   data-nav-link: active 메뉴 판별용 경로
#}
{% macro nav_link(href, icon, label, active_paths, classes='') %}
<a href="{{ href }}"
   hx-get="{{ href }}"
   hx-target="#page-content"
   hx-select="#page-content"
   hx-swap="outerHTML"
   hx-push-url="true"
   data-nav-link="{{ active_paths }}"
   class="flex items-center gap-3 px-4 py-3 rounded-lg transition-colors
          {% set paths = active_paths.split(',') %}
          {% set is_active = false %}
          {% for p in paths %}
              {% if current_path == p or (p != '/' and p in current_path) %}
                  {% set is_active = true %}
              {% endif %}
          {% endfor %}
          {% if is_active %}bg-primary-800{% else %}hover:bg-primary-800{% endif %}
          {{ classes }}">
    {{ svg_icon(icon, 'w-5 h-5 flex-shrink-0') }}
    <span x-show="sidebarOpen" x-cloak>{{ label }}</span>
</a>
{% endmacro %}

{# 서버 필요 메뉴: 서버 선택됐으면 해당 경로, 아니면 /servers?next=원래경로 로 이동 #}
{% macro server_nav_link(path, icon, label, active_paths, classes='') %}
{% if has_server %}
    {{ nav_link(path + sid, icon, label, active_paths, classes) }}
{% else %}
    {{ nav_link('/servers?next=' + path, icon, label, active_paths, classes) }}
{% endif %}
{% endmacro %}

<!-- 현재 선택된 서버 표시 -->
{% if has_server and server_name is defined and server_name %}
<div class="mx-2 mb-4 px-3 py-2 bg-primary-800 rounded-lg">
    <div class="text-xs text-primary-400" x-show="sidebarOpen" x-cloak>선택된 서버</div>
    <div class="text-sm font-medium truncate" x-show="sidebarOpen" x-cloak>{{ server_name }}</div>
    <div class="w-2 h-2 bg-green-400 rounded-full mx-auto" x-show="!sidebarOpen" x-cloak title="{{ server_name }}"></div>
</div>
{% elif not has_server %}
<div class="mx-2 mb-4 px-3 py-2 bg-yellow-900/30 border border-yellow-700/50 rounded-lg" x-show="sidebarOpen" x-cloak>
    <div class="text-xs text-yellow-400">⚠ 서버를 선택해주세요</div>
</div>
{% endif %}

<!-- 서버 관리 (최상단 — 서버 선택 불필요) -->
<div>
    {{ nav_link('/servers', 'server', '서버 관리', '/servers,/server-management') }}
    {{ server_nav_link('/dashboard', 'chart-bar', '모니터링', '/dashboard') }}
</div>

<!-- DB 관리 그룹 -->
<div class="mt-4 pt-4 border-t border-primary-800">
    <div class="px-4 py-2 text-xs text-primary-400 uppercase tracking-wide" x-show="sidebarOpen" x-cloak>
        DB 관리
    </div>
    
    {{ server_nav_link('/db/create', 'plus-circle', 'DB 생성', '/db/create') }}
    {{ server_nav_link('/db/table-init', 'arrow-path', '테이블 초기화', '/db/table-init') }}
    {{ server_nav_link('/db/list', 'circle-stack', 'DB 목록', '/db/list') }}
</div>

<!-- 도구 그룹 -->
<div class="mt-4 pt-4 border-t border-primary-800">
    <div class="px-4 py-2 text-xs text-primary-400 uppercase tracking-wide" x-show="sidebarOpen" x-cloak>
        도구
    </div>
    
    {{ server_nav_link('/data-copy', 'document-duplicate', '데이터 복사', '/data-copy') }}
    {{ server_nav_link('/db-sync', 'arrows-right-left', 'DB 동기화', '/db-sync') }}
    {{ server_nav_link('/tables', 'table-cells', '테이블 현황', '/tables') }}
    {{ server_nav_link('/schema-export', 'document-arrow-down', '테이블 정의서', '/schema-export') }}
</div>

<!-- 시스템 그룹 -->
<div class="mt-4 pt-4 border-t border-primary-800">
    {{ server_nav_link('/activity-logs', 'clipboard-document-list', '활동 로그', '/activity-logs') }}
    {{ nav_link('/settings', 'cog', '설정', '/settings') }}
    
    {% if is_admin %}
    {{ nav_link('/user-management', 'users', '사용자 관리', '/user-management') }}
    {% endif %}
</div>