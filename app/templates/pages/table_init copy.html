{% extends "base.html" %}
{% from "components/icons.html" import svg_icon %}
{% from "components/modals.html" import table_action_modal, alert_modal, confirm_modal %}

{% block title %}테이블 초기화 - 법인 DB 관리 시스템{% endblock %}

{% block content %}
<div x-data="tableInitApp()" x-init="init()" class="space-y-6">
    <!-- 페이지 헤더 -->
    <div class="mb-6">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">
                {{ svg_icon('table-cells', 'w-6 h-6') }}
            </div>
            <div>
                <h1 class="text-2xl font-bold text-gray-800">테이블 초기화</h1>
                <p class="text-gray-500 mt-1">소스 DB의 테이블 데이터를 타겟 DB로 복사합니다 (법인코드 자동 치환)</p>
            </div>
        </div>
    </div>
    
    <!-- 소스/타겟 DB 설정 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- 소스 (원본) -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
                <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                    {{ svg_icon('arrow-up-tray', 'w-5 h-5') }}
                    소스 (원본 DB)
                </h2>
            </div>
            <div class="p-6 space-y-4">
                <!-- 서버 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">서버 *</label>
                    <select x-model="sourceServerId" @change="loadSourceDatabases()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500">
                        <option value="">서버 선택</option>
                        {% for server in servers %}
                        <option value="{{ server.id }}">{{ server.server_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- DB -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">DB *</label>
                    <select x-model="sourceDbName" @change="onSourceDbChange()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500">
                        <option value="">먼저 서버를 선택하세요</option>
                        <template x-for="db in sourceDatabases" :key="db">
                            <option :value="db" x-text="db"></option>
                        </template>
                    </select>
                </div>
                
                <!-- 소스 DB 정보 -->
                <div x-show="sourceCorpCode" class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="flex items-center gap-2 text-blue-700 font-medium text-sm">
                        {{ svg_icon('check', 'w-4 h-4') }}
                        소스 DB 선택됨
                    </div>
                    <div class="text-sm text-blue-600 mt-1">
                        <span class="font-mono" x-text="sourceDbName"></span><br>
                        법인: <span x-text="sourceCorpName"></span> (<span x-text="sourceCorpCode"></span>)
                    </div>
                </div>
                <div x-show="sourceDbName && !sourceCorpCode" class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <div class="text-sm text-yellow-700">
                        <span class="font-mono" x-text="sourceDbName"></span> - 법인 정보 없음
                    </div>
                </div>
                <div x-show="!sourceDbName" class="text-sm text-gray-500">
                    <p>복사할 데이터의 원본 DB를 선택하세요.</p>
                </div>
            </div>
        </div>
        
        <!-- 타겟 (대상) - 단일 선택 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-green-600 to-green-700 px-6 py-4">
                <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                    {{ svg_icon('arrow-down-tray', 'w-5 h-5') }}
                    타겟 (대상 DB)
                </h2>
            </div>
            <div class="p-6 space-y-4">
                <!-- 서버 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">서버 *</label>
                    <select x-model="targetServerId" @change="loadTargetDatabases()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500">
                        <option value="">서버 선택</option>
                        {% for server in servers %}
                        <option value="{{ server.id }}">{{ server.server_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- DB 선택 (단일) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">DB *</label>
                    <select x-model="targetDbName" @change="onTargetDbChange()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500">
                        <option value="">먼저 서버를 선택하세요</option>
                        <template x-for="db in targetDatabases" :key="db">
                            <option :value="db" x-text="db"></option>
                        </template>
                    </select>
                </div>
                
                <!-- 타겟 DB 정보 -->
                <div x-show="targetCorpCode" class="bg-green-50 border border-green-200 rounded-lg p-3">
                    <div class="flex items-center gap-2 text-green-700 font-medium text-sm">
                        {{ svg_icon('check', 'w-4 h-4') }}
                        타겟 DB 선택됨
                    </div>
                    <div class="text-sm text-green-600 mt-1">
                        법인: <span x-text="targetCorpName"></span> (<span x-text="targetCorpCode"></span>)
                    </div>
                </div>
                <div x-show="targetDbName && !targetCorpCode" class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <div class="text-sm text-yellow-700">
                        법인 정보를 찾을 수 없습니다. 법인코드 치환이 동작하지 않습니다.
                    </div>
                </div>
                <div x-show="!targetDbName" class="text-sm text-gray-500">
                    <p>데이터를 복사할 대상 DB를 선택하세요.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 복사 옵션 패널 -->
    <div x-show="sourceDbName && targetDbName"
         x-transition
         class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
        <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
            {{ svg_icon('cog-6-tooth', 'w-4 h-4') }}
            복사 옵션
        </h3>
        <div class="flex flex-wrap gap-6">
            <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                <input type="checkbox" x-model="optTruncate"
                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span>TRUNCATE 후 INSERT</span>
                <span class="text-xs text-gray-400">(기존 데이터 삭제)</span>
            </label>
            <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                <input type="checkbox" x-model="optReplaceCorp"
                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span>법인코드 자동 치환</span>
            </label>
            <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                <input type="checkbox" x-model="optKeepIdentity"
                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span>Identity 값 유지</span>
            </label>
        </div>
    </div>

    <!-- 테이블 목록 -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="bg-gradient-to-r from-gray-700 to-gray-800 px-6 py-4">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                    {{ svg_icon('table-cells', 'w-5 h-5') }}
                    테이블 목록
                </h2>
                <div class="flex items-center gap-3">
                    <!-- #6: 일괄 실행 버튼 -->
                    <template x-if="selectedTables.length > 0 && !batchRunning">
                        <div class="flex items-center gap-2">
                            <span class="text-white/70 text-sm" x-text="selectedTables.length + '개 선택'"></span>
                            <button @click="batchInsert()"
                                    :disabled="!targetDbName"
                                    class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded hover:bg-blue-400 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                선택 INSERT
                            </button>
                            <button @click="batchDelete()"
                                    :disabled="!targetDbName"
                                    class="px-3 py-1.5 bg-red-500 text-white text-sm rounded hover:bg-red-400 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                선택 DELETE
                            </button>
                            <button @click="selectedTables = []"
                                    class="px-2 py-1.5 text-white/60 text-sm hover:text-white transition">
                                해제
                            </button>
                        </div>
                    </template>
                    <!-- 건수 > 0 필터 + 상태 리셋 -->
                    <div class="flex items-center gap-2">
                        <label class="flex items-center gap-1 text-white/70 text-xs cursor-pointer" title="건수 > 0인 테이블만 표시">
                            <input type="checkbox" x-model="filterHasData"
                                   class="rounded border-white/30 text-blue-400 focus:ring-0 w-3.5 h-3.5">
                            <span>데이터 있음</span>
                        </label>
                        <button x-show="Object.keys(tableStatus).length > 0"
                                @click="tableStatus = {}; tableStatusText = {}"
                                class="text-white/50 text-xs hover:text-white transition" title="상태 초기화">
                            ↺ 리셋
                        </button>
                    </div>
                    <input type="text" x-model="tableSearch" placeholder="테이블 검색..."
                           class="px-3 py-1.5 text-sm rounded border-0 focus:ring-2 focus:ring-white/50">
                    <span class="text-white/70 text-sm" x-text="filteredTables.length + '개'"></span>
                </div>
            </div>
        </div>

        <!-- #12: 일괄 실행 진행률 -->
        <div x-show="batchRunning" class="bg-blue-50 border-b border-blue-200 px-6 py-3">
            <div class="flex justify-between text-sm mb-2">
                <span class="text-blue-700 font-medium" x-text="'진행 중: ' + batchCurrent + ' / ' + batchTotal"></span>
                <span class="text-blue-600 font-mono text-xs" x-text="batchCurrentTable"></span>
            </div>
            <div class="w-full bg-blue-200 rounded-full h-2">
                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                     :style="'width: ' + (batchTotal > 0 ? (batchCurrent / batchTotal * 100) : 0) + '%'"></div>
            </div>
        </div>

        <div class="divide-y divide-gray-100">
            <!-- 로딩 / 빈 상태 -->
            <div x-show="loading" class="p-8 text-center text-gray-500">테이블 목록 조회 중...</div>
            <div x-show="!loading && !sourceDbName" class="p-8 text-center text-gray-400">
                소스 DB를 선택하면 테이블 목록이 표시됩니다
            </div>
            <div x-show="!loading && sourceDbName && filteredTables.length === 0" class="p-8 text-center text-gray-400">
                테이블이 없습니다
            </div>

            <!-- 테이블 목록 -->
            <table x-show="!loading && filteredTables.length > 0" class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <!-- #6: 전체 선택 체크박스 -->
                        <th class="px-3 py-3 text-center w-10">
                            <input type="checkbox" @change="toggleSelectAll($event)"
                                   :checked="selectedTables.length > 0 && selectedTables.length === filteredTables.length"
                                   :disabled="batchRunning"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">테이블명</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">설명</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">건수</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">법인코드 컬럼</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">상태</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">액션</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <template x-for="table in filteredTables" :key="table.table_name">
                        <tr class="hover:bg-gray-50" :class="{'bg-green-50': tableStatus[table.table_name] === 'success', 'bg-red-50': tableStatus[table.table_name] === 'error'}">
                            <!-- #6: 행 체크박스 -->
                            <td class="px-3 py-3 text-center">
                                <input type="checkbox" :value="table.table_name"
                                       x-model="selectedTables"
                                       :disabled="batchRunning"
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            </td>
                            <td class="px-4 py-3 font-mono text-sm" x-text="table.table_name"></td>
                            <td class="px-4 py-3 text-sm text-gray-600 max-w-xs truncate" :title="table.description">
                                <span x-text="table.description || '-'" :class="{'text-gray-300': !table.description}"></span>
                            </td>
                            <td class="px-4 py-3 text-right text-sm text-gray-600" x-text="(table.row_count || 0).toLocaleString()"></td>
                            <td class="px-4 py-3 text-center">
                                <select :id="'corp-col-' + table.table_name" 
                                        @focus="loadTableColumns(table.table_name)"
                                        x-model="selectedCorpColumns[table.table_name]"
                                        class="px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:border-primary-500 min-w-[120px]">
                                    <option :value="table.corp_code_column || ''" x-text="table.corp_code_column || '선택...'"></option>
                                </select>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span x-show="!tableStatus[table.table_name]" class="text-gray-400 text-xs">대기</span>
                                <span x-show="tableStatus[table.table_name] === 'loading'" class="text-blue-600 text-xs">진행중...</span>
                                <span x-show="tableStatus[table.table_name] === 'success'" class="text-green-600 text-xs" x-text="tableStatusText[table.table_name]"></span>
                                <span x-show="tableStatus[table.table_name] === 'error'" class="text-red-600 text-xs">실패</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex items-center justify-center gap-1">
                                    <button @click="showActionModal(table.table_name, 'INSERT')"
                                            :disabled="tableStatus[table.table_name] === 'loading' || !targetDbName"
                                            class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                        INSERT
                                    </button>
                                    <button @click="showActionModal(table.table_name, 'DELETE')"
                                            :disabled="tableStatus[table.table_name] === 'loading' || !targetDbName"
                                            class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                        DELETE
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 테이블 액션 확인 모달 -->
    {{ table_action_modal() }}
    
    <!-- 알림 모달 -->
    {{ alert_modal() }}
    
    <!-- 확인 모달 (일괄 DELETE용) -->
    {{ confirm_modal() }}
    
    <!-- 결과 모달 -->
    <div x-show="showResultModal" 
         x-cloak
         x-transition
         class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold" :class="resultData.success ? 'text-green-700' : 'text-red-700'">
                    <span x-text="resultData.success ? '✅' : '❌'"></span>
                    <span x-text="resultData.action === 'INSERT' ? '데이터 복사' : '데이터 삭제'"></span>
                    <span x-text="resultData.success ? '완료' : '실패'"></span>
                </h3>
                <button @click="showResultModal = false" class="text-gray-400 hover:text-gray-600">
                    {{ svg_icon('x-mark', 'w-6 h-6') }}
                </button>
            </div>
            
            <div class="space-y-3 mb-4">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">테이블</span>
                    <span class="font-mono font-medium" x-text="resultData.table_name"></span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">소스 DB</span>
                    <span class="font-mono" x-text="resultData.source_db"></span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">타겟 DB</span>
                    <span class="font-mono" x-text="resultData.target_db"></span>
                </div>
                <template x-if="resultData.action === 'INSERT'">
                    <div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">복사 건수</span>
                            <span class="font-medium text-blue-600" x-text="(resultData.rows_copied || 0).toLocaleString()"></span>
                        </div>
                        <div class="flex justify-between text-sm mt-2">
                            <span class="text-gray-500">치환 건수</span>
                            <span class="font-medium text-blue-600" x-text="(resultData.rows_replaced || 0).toLocaleString()"></span>
                        </div>
                    </div>
                </template>
                <template x-if="resultData.action === 'DELETE'">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">삭제 건수</span>
                        <span class="font-medium text-red-600" x-text="(resultData.rows_deleted || 0).toLocaleString()"></span>
                    </div>
                </template>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">소요 시간</span>
                    <span x-text="(resultData.elapsed_seconds || 0).toFixed(2) + '초'"></span>
                </div>
            </div>
            
            <template x-if="resultData.error_message">
                <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                    <div class="text-sm text-red-700 font-medium" x-text="resultData.error_message"></div>
                    <template x-if="resultData.error_detail && resultData.error_detail !== resultData.error_message">
                        <details class="mt-2">
                            <summary class="text-xs text-red-500 cursor-pointer">상세 에러 보기</summary>
                            <pre class="text-xs text-red-600 mt-1 whitespace-pre-wrap break-all max-h-32 overflow-y-auto" x-text="resultData.error_detail"></pre>
                        </details>
                    </template>
                </div>
            </template>
            
            <div class="flex justify-end">
                <button @click="showResultModal = false" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    닫기
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function tableInitApp() {
    return {
        // 소스 DB
        sourceServerId: '',
        sourceDbName: '',
        sourceDatabases: [],
        sourceCorpCode: '',
        sourceCorpName: '',

        // 타겟 DB
        targetServerId: '',
        targetDbName: '',
        targetDatabases: [],
        targetCorpCode: '',
        targetCorpName: '',

        // 옵션
        optTruncate: true,
        optReplaceCorp: true,
        optKeepIdentity: false,

        // 테이블 목록
        tables: [],
        tableSearch: '',
        loading: false,
        selectedCorpColumns: {},
        tableStatus: {},
        tableStatusText: {},
        loadedColumns: {},

        // #6: 일괄 실행
        selectedTables: [],
        batchRunning: false,
        batchCurrent: 0,
        batchTotal: 0,
        batchCurrentTable: '',

        // 추가: 건수 필터
        filterHasData: false,
        
        // 모달
        showTableActionModal: false,
        tableActionData: {},
        showAlertModal: false,
        alertData: {},
        showResultModal: false,
        resultData: {},
        showConfirmModal: false,
        confirmData: {},
        
        // computed
        get filteredTables() {
            let list = this.tables;
            // 건수 > 0 필터
            if (this.filterHasData) {
                list = list.filter(t => (t.row_count || 0) > 0);
            }
            // 검색
            if (this.tableSearch) {
                const keyword = this.tableSearch.toLowerCase();
                list = list.filter(t =>
                    t.table_name.toLowerCase().includes(keyword) ||
                    (t.description && t.description.toLowerCase().includes(keyword))
                );
            }
            return list;
        },

        // API 응답에서 DB명 문자열 배열 추출 (객체/문자열 배열 모두 대응)
        _extractDbNames(data) {
            if (!Array.isArray(data)) return [];
            return data.map(item => {
                if (typeof item === 'string') return item;
                if (typeof item === 'object' && item !== null) {
                    return item.name || item.database_name || item.db_name || Object.values(item)[0] || '';
                }
                return String(item);
            }).filter(v => v);
        },

        // ── 초기화 (URL 파라미터 자동 선택) ──
        async init() {
            const params = new URLSearchParams(window.location.search);
            const sourceDb = params.get('source_db');
            const targetDb = params.get('target_db');

            // 현재 서버 기본 선택
            const currentServerId = '{{ server_id or "" }}';
            if (currentServerId) {
                this.sourceServerId = currentServerId;
                this.targetServerId = currentServerId;
                await this.loadSourceDatabases();
                await this.loadTargetDatabases();
            }

            // URL 파라미터로 DB 자동 선택
            if (sourceDb && this.sourceDatabases.includes(sourceDb)) {
                this.sourceDbName = sourceDb;
                await this.onSourceDbChange();
            }
            if (targetDb && this.targetDatabases.includes(targetDb)) {
                this.targetDbName = targetDb;
                await this.onTargetDbChange();
            }
        },

        // 소스 DB 로드
        async loadSourceDatabases() {
            if (!this.sourceServerId) {
                this.sourceDatabases = [];
                return;
            }
            try {
                const response = await fetch(`/api/servers/${this.sourceServerId}/databases`);
                const data = await response.json();
                this.sourceDatabases = this._extractDbNames(data);
            } catch (error) {
                this.sourceDatabases = [];
            }
        },
        
        async onSourceDbChange() {
            this.sourceCorpCode = '';
            this.sourceCorpName = '';
            this.tables = [];
            this.tableStatus = {};
            this.tableStatusText = {};
            this.loadedColumns = {};
            this.selectedCorpColumns = {};
            this.selectedTables = [];
            
            if (!this.sourceDbName) return;
            
            // 법인 정보 조회
            try {
                const response = await fetch(`/api/table-init/corp-info-by-db?db_name=${encodeURIComponent(this.sourceDbName)}`);
                const data = await response.json();
                if (data.found) {
                    this.sourceCorpCode = data.corp_code;
                    this.sourceCorpName = data.corp_name;
                }
            } catch (error) {}
            
            // 테이블 목록 로드
            await this.loadTables();
        },
        
        // 타겟 DB 로드
        async loadTargetDatabases() {
            if (!this.targetServerId) {
                this.targetDatabases = [];
                return;
            }
            try {
                const response = await fetch(`/api/servers/${this.targetServerId}/databases`);
                const data = await response.json();
                this.targetDatabases = this._extractDbNames(data);
            } catch (error) {
                this.targetDatabases = [];
            }
            this.targetCorpCode = '';
            this.targetCorpName = '';
        },
        
        async onTargetDbChange() {
            this.targetCorpCode = '';
            this.targetCorpName = '';
            
            if (!this.targetDbName) return;
            
            try {
                const response = await fetch(`/api/table-init/corp-info-by-db?db_name=${encodeURIComponent(this.targetDbName)}`);
                const data = await response.json();
                if (data.found) {
                    this.targetCorpCode = data.corp_code;
                    this.targetCorpName = data.corp_name;
                }
            } catch (error) {}
        },
        
        // 테이블 목록 로드
        async loadTables() {
            if (!this.sourceServerId || !this.sourceDbName) return;
            
            this.loading = true;
            try {
                const response = await fetch(`/api/table-init/tables/${this.sourceServerId}/${this.sourceDbName}`);
                this.tables = await response.json();
                
                // 초기 법인코드 컬럼 설정
                this.tables.forEach(t => {
                    this.selectedCorpColumns[t.table_name] = t.corp_code_column || '';
                });
            } catch (error) {
                this.tables = [];
            }
            this.loading = false;
        },
        
        // 테이블 컬럼 로드
        async loadTableColumns(tableName) {
            if (this.loadedColumns[tableName]) return;
            
            const select = document.getElementById(`corp-col-${tableName}`);
            if (!select) return;
            
            const currentValue = this.selectedCorpColumns[tableName];
            
            try {
                const response = await fetch(`/api/table-init/columns/${this.sourceServerId}/${this.sourceDbName}/${tableName}`);
                const columns = await response.json();
                
                select.innerHTML = '<option value="">(없음)</option>';
                columns.forEach(col => {
                    const option = document.createElement('option');
                    option.value = col.column_name;
                    option.textContent = col.column_name;
                    if (col.column_name === currentValue) option.selected = true;
                    select.appendChild(option);
                });
                
                this.loadedColumns[tableName] = true;
            } catch (error) {}
        },
        
        // 액션 모달 표시 (#3: 건수 표시 + DELETE 경고)
        showActionModal(tableName, action) {
            if (!this.targetDbName) {
                this.alertData = { title: '알림', message: '타겟 DB를 선택해주세요.', type: 'warning' };
                this.showAlertModal = true;
                return;
            }

            // 소스/타겟 동일 DB 검증
            if (this.sourceServerId === this.targetServerId && this.sourceDbName === this.targetDbName) {
                this.alertData = {
                    title: '실행 불가',
                    message: '소스와 타겟이 동일한 서버/DB입니다. 다른 DB를 선택해주세요.',
                    type: 'error'
                };
                this.showAlertModal = true;
                return;
            }

            const table = this.tables.find(t => t.table_name === tableName);
            const corpCol = this.selectedCorpColumns[tableName] || null;

            // 법인코드 치환 옵션이 켜져 있을 때, 컬럼이 로드되지 않았거나 선택되지 않은 경우 차단
            if (this.optReplaceCorp && this.sourceCorpCode && this.targetCorpCode) {
                if (!corpCol && !this.loadedColumns[tableName]) {
                    // 컬럼 미로드 상태 — 드롭다운을 먼저 클릭해서 컬럼을 확인하라고 안내
                    this.alertData = {
                        title: '법인코드 컬럼 확인 필요',
                        message: `'${tableName}' 테이블의 법인코드 컬럼을 먼저 확인해주세요. 드롭다운을 클릭하여 컬럼을 로드한 후 선택하거나, 해당 테이블에 법인코드 컬럼이 없으면 (없음)을 선택하세요.`,
                        type: 'warning'
                    };
                    this.showAlertModal = true;
                    return;
                }
            }

            let warning = '';

            // DELETE 시 법인코드 미지정이면 TRUNCATE 경고
            if (action === 'DELETE' && (!corpCol || !this.targetCorpCode)) {
                warning = '⚠️ 법인코드 컬럼이 지정되지 않아 테이블 전체 데이터가 삭제(TRUNCATE)됩니다!';
            }

            this.tableActionData = {
                action: action,
                tableName: tableName,
                sourceDb: this.sourceDbName,
                targetDb: this.targetDbName,
                sourceCorpCode: this.sourceCorpCode,
                targetCorpCode: this.targetCorpCode,
                rowCount: table ? (table.row_count || 0) : 0,
                corpCodeColumn: corpCol,
                warning: warning
            };
            this.showTableActionModal = true;
        },

        // 액션 확인 (모달에서 호출)
        async onTableActionConfirm() {
            const { action, tableName } = this.tableActionData;
            this.showTableActionModal = false;  // #2: 모달 즉시 닫기 (더블 클릭 방지)
            await this.executeAction(tableName, action);
        },

        // 액션 실행
        async executeAction(tableName, action) {
            // #2: 이미 실행 중이면 무시
            if (this.tableStatus[tableName] === 'loading') return;
            this.tableStatus[tableName] = 'loading';

            const corpCodeColumn = this.selectedCorpColumns[tableName] || null;

            const requestData = {
                source_server_id: parseInt(this.sourceServerId),
                source_db_name: this.sourceDbName,
                target_server_id: parseInt(this.targetServerId),
                target_db_name: this.targetDbName,
                table_name: tableName,
                source_corp_code: this.sourceCorpCode || '',
                target_corp_code: this.targetCorpCode || '',
                corp_code_column: corpCodeColumn,
                action: action,
                truncate_before_copy: action === 'INSERT' ? this.optTruncate : false,
                replace_corp_code: this.optReplaceCorp,
                keep_identity: this.optKeepIdentity
            };

            try {
                const response = await fetch('/api/table-init/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                result.action = action;

                if (result.success) {
                    this.tableStatus[tableName] = 'success';
                    // #8: 성공 시 건수 표시
                    if (action === 'INSERT') {
                        this.tableStatusText[tableName] = (result.rows_copied || 0).toLocaleString() + '건 복사';
                    } else {
                        this.tableStatusText[tableName] = (result.rows_deleted || 0).toLocaleString() + '건 삭제';
                    }
                } else {
                    this.tableStatus[tableName] = 'error';
                    this.tableStatusText[tableName] = '실패';
                }

                this.resultData = result;
                this.showResultModal = true;

            } catch (error) {
                this.tableStatus[tableName] = 'error';
                this.tableStatusText[tableName] = '오류';
                this.alertData = { title: '오류', message: error.message, type: 'error' };
                this.showAlertModal = true;
            }
        },

        // ── #6: 전체 선택 / 해제 ──
        toggleSelectAll(event) {
            if (event.target.checked) {
                this.selectedTables = this.filteredTables.map(t => t.table_name);
            } else {
                this.selectedTables = [];
            }
        },

        // ── #6: 일괄 INSERT (건수 > 0 테이블만) ──
        async batchInsert() {
            // 동일 DB 검증
            if (this.sourceServerId === this.targetServerId && this.sourceDbName === this.targetDbName) {
                this.alertData = {
                    title: '실행 불가',
                    message: '소스와 타겟이 동일한 서버/DB입니다.',
                    type: 'error'
                };
                this.showAlertModal = true;
                return;
            }

            if (!this.targetDbName) {
                this.alertData = { title: '알림', message: '타겟 DB를 선택해주세요.', type: 'warning' };
                this.showAlertModal = true;
                return;
            }

            // 건수 > 0인 테이블만 필터
            const targets = this.selectedTables.filter(name => {
                const t = this.tables.find(tb => tb.table_name === name);
                return t && t.row_count > 0;
            });

            if (targets.length === 0) {
                this.alertData = {
                    title: '알림',
                    message: '선택된 테이블 중 데이터가 있는 테이블이 없습니다.',
                    type: 'warning'
                };
                this.showAlertModal = true;
                return;
            }

            // 법인코드 컬럼 미확인 테이블 검증
            if (this.optReplaceCorp && this.sourceCorpCode && this.targetCorpCode) {
                const unloadedTables = targets.filter(name => {
                    const corpCol = this.selectedCorpColumns[name] || '';
                    return !corpCol && !this.loadedColumns[name];
                });
                if (unloadedTables.length > 0) {
                    this.alertData = {
                        title: '법인코드 컬럼 확인 필요',
                        message: `${unloadedTables.length}개 테이블의 법인코드 컬럼이 확인되지 않았습니다. 각 테이블의 드롭다운을 클릭하여 컬럼을 확인해주세요: ${unloadedTables.slice(0, 5).join(', ')}${unloadedTables.length > 5 ? ' 외 ' + (unloadedTables.length - 5) + '개' : ''}`,
                        type: 'warning'
                    };
                    this.showAlertModal = true;
                    return;
                }
            }

            this.batchRunning = true;
            this.batchTotal = targets.length;
            this.batchCurrent = 0;
            this.batchCurrentTable = '';

            let successCount = 0;
            let failCount = 0;

            for (const tableName of targets) {
                this.batchCurrent++;
                this.batchCurrentTable = tableName;

                // executeAction에서 모달 표시하지 않도록 직접 실행
                await this._executeSingle(tableName, 'INSERT');

                if (this.tableStatus[tableName] === 'success') {
                    successCount++;
                } else {
                    failCount++;
                }
            }

            this.batchRunning = false;
            this.batchCurrentTable = '';
            this.selectedTables = [];

            // 일괄 완료 알림
            this.alertData = {
                title: '일괄 INSERT 완료',
                message: `총 ${targets.length}개 테이블: 성공 ${successCount}개` + (failCount > 0 ? `, 실패 ${failCount}개` : ''),
                type: failCount > 0 ? 'warning' : 'success'
            };
            this.showAlertModal = true;
        },

        // ── 일괄 DELETE ──
        async batchDelete() {
            // 동일 DB 검증
            if (this.sourceServerId === this.targetServerId && this.sourceDbName === this.targetDbName) {
                this.alertData = { title: '실행 불가', message: '소스와 타겟이 동일한 서버/DB입니다.', type: 'error' };
                this.showAlertModal = true;
                return;
            }
            if (!this.targetDbName) {
                this.alertData = { title: '알림', message: '타겟 DB를 선택해주세요.', type: 'warning' };
                this.showAlertModal = true;
                return;
            }

            const targets = [...this.selectedTables];
            if (targets.length === 0) return;

            // 커스텀 확인 모달
            this.confirmData = {
                title: '일괄 DELETE 확인',
                message: `선택된 ${targets.length}개 테이블의 타겟 DB(${this.targetDbName}) 데이터를 삭제합니다. 이 작업은 되돌릴 수 없습니다.`,
                confirmText: '삭제',
                cancelText: '취소',
                type: 'danger'
            };
            this._pendingBatchDeleteTargets = targets;
            this.showConfirmModal = true;
        },

        // 확인 모달에서 호출
        async onConfirm() {
            const targets = this._pendingBatchDeleteTargets;
            if (!targets || targets.length === 0) return;
            this._pendingBatchDeleteTargets = null;

            this.batchRunning = true;
            this.batchTotal = targets.length;
            this.batchCurrent = 0;
            this.batchCurrentTable = '';

            let successCount = 0;
            let failCount = 0;

            for (const tableName of targets) {
                this.batchCurrent++;
                this.batchCurrentTable = tableName;
                await this._executeSingle(tableName, 'DELETE');
                if (this.tableStatus[tableName] === 'success') {
                    successCount++;
                } else {
                    failCount++;
                }
            }

            this.batchRunning = false;
            this.batchCurrentTable = '';
            this.selectedTables = [];

            this.alertData = {
                title: '일괄 DELETE 완료',
                message: `총 ${targets.length}개 테이블: 성공 ${successCount}개` + (failCount > 0 ? `, 실패 ${failCount}개` : ''),
                type: failCount > 0 ? 'warning' : 'success'
            };
            this.showAlertModal = true;
        },

        // ── 단일 실행 (모달 없이, 일괄용) ──
        async _executeSingle(tableName, action) {
            if (this.tableStatus[tableName] === 'loading') return;
            this.tableStatus[tableName] = 'loading';

            const corpCodeColumn = this.selectedCorpColumns[tableName] || null;

            const requestData = {
                source_server_id: parseInt(this.sourceServerId),
                source_db_name: this.sourceDbName,
                target_server_id: parseInt(this.targetServerId),
                target_db_name: this.targetDbName,
                table_name: tableName,
                source_corp_code: this.sourceCorpCode || '',
                target_corp_code: this.targetCorpCode || '',
                corp_code_column: corpCodeColumn,
                action: action,
                truncate_before_copy: action === 'INSERT' ? this.optTruncate : false,
                replace_corp_code: this.optReplaceCorp,
                keep_identity: this.optKeepIdentity
            };

            try {
                const response = await fetch('/api/table-init/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (result.success) {
                    this.tableStatus[tableName] = 'success';
                    if (action === 'INSERT') {
                        this.tableStatusText[tableName] = (result.rows_copied || 0).toLocaleString() + '건 복사';
                    } else {
                        this.tableStatusText[tableName] = (result.rows_deleted || 0).toLocaleString() + '건 삭제';
                    }
                } else {
                    this.tableStatus[tableName] = 'error';
                    this.tableStatusText[tableName] = '실패';
                }
            } catch (error) {
                this.tableStatus[tableName] = 'error';
                this.tableStatusText[tableName] = '오류';
            }
        }
    };
}
</script>
{% endblock %}