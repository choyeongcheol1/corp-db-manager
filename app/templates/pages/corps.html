{% extends "base.html" %}
{% from "components/icons.html" import svg_icon %}

{% block title %}법인 DB 목록 - DB 관리 시스템{% endblock %}

{% block server_selector %}
{% include "components/server_dropdown.html" %}
{% endblock %}

{% block content %}
<div>
    <!-- 페이지 헤더 -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center text-primary-600">
                {{ svg_icon('circle-stack', 'w-6 h-6') }}
            </div>
            <div>
                <h1 class="text-2xl font-bold text-gray-800">법인 DB 목록</h1>
                <p class="text-gray-500 mt-1">
                    {% if current_server %}
                    {{ current_server.server_name }} 서버의 법인 DB
                    {% else %}
                    전체 서버의 법인 DB
                    {% endif %}
                </p>
            </div>
        </div>
        
        <a href="/corps/create{% if server_id %}/{{ server_id }}{% endif %}" 
           class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition flex items-center gap-2">
            {{ svg_icon('plus-circle', 'w-5 h-5') }}
            신규 법인 생성
        </a>
    </div>
    
    <!-- ── 요약 카드 ── -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
        <button onclick="filterByStatus('')" id="card-total"
                class="bg-white rounded-xl p-4 shadow-sm border-2 border-primary-400 text-left transition hover:shadow-md">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-400 uppercase tracking-wide">전체</p>
                    <p class="text-2xl font-bold text-gray-800 mt-1" id="count-total">-</p>
                </div>
                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                    {{ svg_icon('circle-stack', 'w-5 h-5 text-gray-500') }}
                </div>
            </div>
        </button>
        <button onclick="filterByStatus('normal')" id="card-normal"
                class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 text-left transition hover:shadow-md">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-400 uppercase tracking-wide">정상</p>
                    <p class="text-2xl font-bold text-green-600 mt-1" id="count-normal">-</p>
                </div>
                <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center">
                    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                </div>
            </div>
        </button>
        <button onclick="filterByStatus('warning')" id="card-warning"
                class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 text-left transition hover:shadow-md">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-400 uppercase tracking-wide">경고</p>
                    <p class="text-2xl font-bold text-yellow-600 mt-1" id="count-warning">-</p>
                </div>
                <div class="w-10 h-10 bg-yellow-50 rounded-lg flex items-center justify-center">
                    <span class="w-3 h-3 bg-yellow-500 rounded-full"></span>
                </div>
            </div>
        </button>
        <button onclick="filterByStatus('error')" id="card-error"
                class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 text-left transition hover:shadow-md">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-medium text-gray-400 uppercase tracking-wide">오류</p>
                    <p class="text-2xl font-bold text-red-600 mt-1" id="count-error">-</p>
                </div>
                <div class="w-10 h-10 bg-red-50 rounded-lg flex items-center justify-center">
                    <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                </div>
            </div>
        </button>
    </div>
    
    <!-- ── 검색 및 필터 ── -->
    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mb-6">
        <div class="flex flex-wrap gap-4 items-end">
            
            <!-- 메인 DB 선택 -->
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">메인 DB</label>
                <select id="main-db-select"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500 text-sm bg-white"
                        onchange="reloadCorpsList()">
                    <option value="">전체 (모든 메인 DB)</option>
                    <!-- JS에서 동적으로 채움 -->
                </select>
            </div>
            
            <!-- 검색 -->
            <div class="flex-1 min-w-[200px]">
                <label class="block text-xs font-medium text-gray-500 mb-1">검색</label>
                <div class="relative">
                    <input type="text" 
                           id="keyword-input"
                           name="keyword" 
                           placeholder="법인코드, 법인명, DB명 검색..."
                           class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500">
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                        {{ svg_icon('magnifying-glass', 'w-5 h-5') }}
                    </div>
                    <!-- 검색 초기화 -->
                    <button id="keyword-clear" class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                            onclick="document.getElementById('keyword-input').value=''; this.classList.add('hidden'); reloadCorpsList();">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- 상태 필터 -->
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">상태</label>
                <select id="status-select"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500"
                        onchange="reloadCorpsList()">
                    <option value="">전체 상태</option>
                    <option value="normal">정상</option>
                    <option value="warning">경고</option>
                    <option value="error">오류</option>
                </select>
            </div>
            
            {% if server_id %}
            <input type="hidden" id="fixed-server-id" value="{{ server_id }}">
            {% else %}
            <!-- 서버 필터 (전체 모드일 때만) -->
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">서버</label>
                <select id="server-select"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500"
                        onchange="reloadCorpsList()">
                    {% for server in servers %}
                    <option value="{{ server.id }}" {% if loop.first %}selected{% endif %}>{{ server.server_name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <!-- 건수 + 로딩 -->
            <div class="flex items-center gap-3 ml-auto">
                <span id="result-count" class="text-sm text-gray-500 font-medium"></span>
                <div id="search-loading" class="hidden flex items-center text-gray-500">
                    <svg class="animate-spin h-4 w-4 mr-1" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                    </svg>
                    <span class="text-sm">조회 중...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ── 메인 컨텐츠: 목록 + 상세 패널 ── -->
    <div class="flex gap-6">
        <!-- 목록 테이블 -->
        <div class="flex-1 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr class="text-left text-sm text-gray-600">
                            <th class="px-5 py-3 font-medium whitespace-nowrap">법인코드</th>
                            <th class="px-5 py-3 font-medium whitespace-nowrap">법인명</th>
                            <th class="px-5 py-3 font-medium whitespace-nowrap">DB명</th>
                            <th class="px-5 py-3 font-medium whitespace-nowrap text-center">상태</th>
                            <th class="px-5 py-3 font-medium whitespace-nowrap">생성일</th>
                            <th class="px-5 py-3 font-medium whitespace-nowrap text-center">바로가기</th>
                        </tr>
                    </thead>
                    <tbody id="corps-table-body"
                           hx-get="/partials/corps/list{% if server_id %}?server_id={{ server_id }}{% elif servers %}?server_id={{ servers[0].id }}{% endif %}"
                           hx-trigger="load"
                           hx-swap="innerHTML">
                        <tr>
                            <td colspan="6" class="px-6 py-16 text-center text-gray-400">
                                <div class="flex flex-col items-center gap-3">
                                    <svg class="animate-spin h-8 w-8 text-primary-400" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                                    </svg>
                                    <span>법인 DB 목록을 불러오는 중...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 상세 패널 -->
        <div id="detail-panel" 
             class="hidden w-96 bg-white rounded-xl shadow-sm border border-gray-100 overflow-y-auto max-h-[calc(100vh-200px)] flex-shrink-0">
        </div>
    </div>
    
    <!-- ── 토스트 알림 ── -->
    <div id="toast-container" 
         class="fixed bottom-6 right-6 z-50 px-4 py-3 rounded-lg shadow-lg text-sm text-white bg-gray-800 transition-all duration-300 opacity-0 translate-y-2 pointer-events-none">
    </div>
</div>

<script>
// ══════════════════════════════════════════════════
// 메인 DB 콤보박스 초기화 (원본 유지)
// ══════════════════════════════════════════════════
(async function() {
    try {
        var res = await fetch('/api/settings/main-db');
        var data = await res.json();
        var select = document.getElementById('main-db-select');
        
        if (select && data.entries && data.entries.length > 0) {
            while (select.options.length > 1) {
                select.remove(1);
            }
            data.entries.forEach(function(entry) {
                var opt = document.createElement('option');
                opt.value = entry.id;
                opt.textContent = entry.label || (entry.server_name + ' / ' + entry.db_name);
                select.appendChild(opt);
            });
        }
    } catch(e) {
        console.error('메인 DB 목록 로드 실패:', e);
    }
})();

// ══════════════════════════════════════════════════
// 법인 목록 새로고침 (원본 로직 100% 유지)
// ══════════════════════════════════════════════════
function reloadCorpsList() {
    var mainDbId = document.getElementById('main-db-select')?.value || '';
    var keyword = document.getElementById('keyword-input')?.value || '';
    var status = document.getElementById('status-select')?.value || '';
    var tbody = document.getElementById('corps-table-body');
    var loading = document.getElementById('search-loading');
    
    if (!tbody) return;
    
    // URL 파라미터 구성 (원본 그대로)
    var params = new URLSearchParams();
    var fixedServerId = document.getElementById('fixed-server-id')?.value || '';
    if (fixedServerId) {
        params.set('server_id', fixedServerId);
    } else {
        var serverId = document.getElementById('server-select')?.value || '';
        if (serverId) params.set('server_id', serverId);
    }
    if (mainDbId) params.set('main_db_id', mainDbId);
    if (keyword) params.set('keyword', keyword);
    if (status) params.set('status', status);
    
    var url = '/partials/corps/list' + (params.toString() ? '?' + params.toString() : '');
    
    // 로딩 표시
    if (loading) loading.classList.remove('hidden');
    
    // HTMX로 새로고침
    htmx.ajax('GET', url, {
        target: '#corps-table-body', 
        swap: 'innerHTML'
    }).then(function() {
        if (loading) loading.classList.add('hidden');
        updateSummary();
    });
}

// ══════════════════════════════════════════════════
// 검색 입력 debounce (원본 유지)
// ══════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', function() {
    var keywordInput = document.getElementById('keyword-input');
    if (keywordInput) {
        keywordInput.addEventListener('input', function() {
            var clearBtn = document.getElementById('keyword-clear');
            if (clearBtn) {
                if (this.value.length > 0) clearBtn.classList.remove('hidden');
                else clearBtn.classList.add('hidden');
            }
            clearTimeout(this._debounce);
            this._debounce = setTimeout(function() {
                reloadCorpsList();
            }, 300);
        });
    }
});

// ══════════════════════════════════════════════════
// HTMX 초기 로드 완료 시 요약 업데이트
// ══════════════════════════════════════════════════
document.addEventListener('htmx:afterSettle', function(e) {
    if (e.detail.target && e.detail.target.id === 'corps-table-body') {
        updateSummary();
    }
});

// ══════════════════════════════════════════════════
// 요약 카드 업데이트
// ══════════════════════════════════════════════════
function updateSummary() {
    var rows = document.querySelectorAll('#corps-table-body tr[data-status]');
    var total = 0, normal = 0, warning = 0, error = 0;
    
    rows.forEach(function(row) {
        total++;
        var s = row.getAttribute('data-status');
        if (s === 'normal') normal++;
        else if (s === 'warning') warning++;
        else if (s === 'error') error++;
    });
    
    document.getElementById('count-total').textContent = total;
    document.getElementById('count-normal').textContent = normal;
    document.getElementById('count-warning').textContent = warning;
    document.getElementById('count-error').textContent = error;
    
    var countEl = document.getElementById('result-count');
    if (countEl) countEl.textContent = total > 0 ? '총 ' + total + '건' : '';
}

// ══════════════════════════════════════════════════
// 상태 카드 클릭 → 필터
// ══════════════════════════════════════════════════
function filterByStatus(status) {
    document.getElementById('status-select').value = status;
    
    ['total', 'normal', 'warning', 'error'].forEach(function(key) {
        var card = document.getElementById('card-' + key);
        if (!card) return;
        var matchStatus = (key === 'total') ? '' : key;
        if (matchStatus === status) {
            card.className = card.className
                .replace(/border border-gray-100/g, '')
                .replace(/border-2 border-primary-400/g, '')
                .trim() + ' border-2 border-primary-400';
        } else {
            card.className = card.className
                .replace(/border-2 border-primary-400/g, '')
                .replace(/border border-gray-100/g, '')
                .trim() + ' border border-gray-100';
        }
    });
    
    reloadCorpsList();
}

// ══════════════════════════════════════════════════
// DB명 클립보드 복사
// ══════════════════════════════════════════════════
function copyDbName(dbName, event) {
    event.stopPropagation();
    navigator.clipboard.writeText(dbName).then(function() {
        showToast(dbName + ' 복사됨');
    });
}

// ══════════════════════════════════════════════════
// 토스트 표시
// ══════════════════════════════════════════════════
function showToast(message) {
    var toast = document.getElementById('toast-container');
    if (!toast) return;
    toast.textContent = message;
    toast.classList.remove('opacity-0', 'translate-y-2', 'pointer-events-none');
    toast.classList.add('opacity-100', 'translate-y-0');
    setTimeout(function() {
        toast.classList.add('opacity-0', 'translate-y-2', 'pointer-events-none');
        toast.classList.remove('opacity-100', 'translate-y-0');
    }, 2000);
}

// ══════════════════════════════════════════════════
// 상세 패널 열기/닫기
// ══════════════════════════════════════════════════
function openDetailPanel() {
    document.getElementById('detail-panel').classList.remove('hidden');
}
function closeDetailPanel() {
    document.getElementById('detail-panel').classList.add('hidden');
}
</script>
{% endblock %}