{% extends "base.html" %}
{% from "components/icons.html" import svg_icon %}

{% block title %}법인 DB 목록 - DB 관리 시스템{% endblock %}

{% block server_selector %}
{% include "components/server_dropdown.html" %}
{% endblock %}

{% block content %}
<div>
    <!-- 페이지 헤더 -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center text-primary-600">
                {{ svg_icon('circle-stack', 'w-6 h-6') }}
            </div>
            <div>
                <h1 class="text-2xl font-bold text-gray-800">법인 DB 목록</h1>
                <p class="text-gray-500 mt-1">
                    {% if current_server %}
                    {{ current_server.server_name }} 서버의 법인 DB
                    {% else %}
                    전체 서버의 법인 DB
                    {% endif %}
                </p>
            </div>
        </div>
        
        <a href="/corps/create{% if server_id %}/{{ server_id }}{% endif %}" 
           class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition flex items-center gap-2">
            {{ svg_icon('plus-circle', 'w-5 h-5') }}
            신규 법인 생성
        </a>
    </div>
    
    <!-- 검색 및 필터 -->
    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mb-6">
        <div class="flex flex-wrap gap-4 items-end">
            
            <!-- 메인 DB 선택 -->
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">메인 DB</label>
                <select id="main-db-select"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500 text-sm bg-white"
                        onchange="reloadCorpsList()">
                    <option value="">전체 (모든 메인 DB)</option>
                    <!-- JS에서 동적으로 채움 -->
                </select>
            </div>
            
            <!-- 검색 -->
            <div class="flex-1 min-w-[200px]">
                <label class="block text-xs font-medium text-gray-500 mb-1">검색</label>
                <div class="relative">
                    <input type="text" 
                           id="keyword-input"
                           name="keyword" 
                           placeholder="법인코드, 법인명, DB명 검색..."
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500">
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                        {{ svg_icon('magnifying-glass', 'w-5 h-5') }}
                    </div>
                </div>
            </div>
            
            <!-- 상태 필터 -->
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">상태</label>
                <select id="status-select"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500"
                        onchange="reloadCorpsList()">
                    <option value="">전체 상태</option>
                    <option value="normal">정상</option>
                    <option value="warning">경고</option>
                    <option value="error">오류</option>
                </select>
            </div>
            
            {% if server_id %}
            <input type="hidden" id="fixed-server-id" value="{{ server_id }}">
            {% else %}
            <!-- 서버 필터 (전체 모드일 때만) -->
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">서버</label>
                <select id="server-select"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-500"
                        onchange="reloadCorpsList()">
                    {% for server in servers %}
                    <option value="{{ server.id }}" {% if loop.first %}selected{% endif %}>{{ server.server_name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <!-- 로딩 표시 -->
            <div id="search-loading" class="hidden flex items-center text-gray-500">
                <svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                </svg>
                검색 중...
            </div>
        </div>
    </div>
    
    <!-- 메인 컨텐츠: 목록 + 상세 패널 -->
    <div class="flex gap-6">
        <!-- 목록 테이블 -->
        <div class="flex-1 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr class="text-left text-sm text-gray-600">
                        <th class="px-6 py-4 font-medium">No</th>
                        <th class="px-6 py-4 font-medium">법인코드</th>
                        <th class="px-6 py-4 font-medium">법인명</th>
                        <th class="px-6 py-4 font-medium">DB명</th>
                        <th class="px-6 py-4 font-medium">상태</th>
                        <th class="px-6 py-4 font-medium">생성일</th>
                        <th class="px-6 py-4 font-medium"></th>
                    </tr>
                </thead>
                <tbody id="corps-table-body"
                       hx-get="/partials/corps/list{% if server_id %}?server_id={{ server_id }}{% elif servers %}?server_id={{ servers[0].id }}{% endif %}"
                       hx-trigger="load"
                       hx-swap="innerHTML">
                    <!-- 초기 로딩 -->
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                            <div class="flex items-center justify-center gap-2">
                                <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                                </svg>
                                로딩 중...
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 상세 패널 (HTMX로 내용 로드) -->
        <div id="detail-panel" 
             class="hidden w-96 bg-white rounded-xl shadow-sm border border-gray-100 overflow-y-auto max-h-[calc(100vh-200px)]">
            <!-- partials/corps/detail.html 내용이 여기에 로드됨 -->
        </div>
    </div>
</div>

<script>
// ── 메인 DB 콤보박스 초기화 ──
(async function() {
    try {
        var res = await fetch('/api/settings/main-db');
        var data = await res.json();
        var select = document.getElementById('main-db-select');
        
        if (select && data.entries && data.entries.length > 0) {
            // 기존 동적 옵션 제거 (첫 번째 '전체' 옵션만 유지)
            while (select.options.length > 1) {
                select.remove(1);
            }
            data.entries.forEach(function(entry) {
                var opt = document.createElement('option');
                opt.value = entry.id;
                opt.textContent = entry.label || (entry.server_name + ' / ' + entry.db_name);
                select.appendChild(opt);
            });
        }
    } catch(e) {
        console.error('메인 DB 목록 로드 실패:', e);
    }
})();

// ── 법인 목록 새로고침 ──
function reloadCorpsList() {
    const mainDbId = document.getElementById('main-db-select')?.value || '';
    const keyword = document.getElementById('keyword-input')?.value || '';
    const status = document.getElementById('status-select')?.value || '';
    const tbody = document.getElementById('corps-table-body');
    const loading = document.getElementById('search-loading');
    
    if (!tbody) return;
    
    // URL 파라미터 구성
    var params = new URLSearchParams();
    var fixedServerId = document.getElementById('fixed-server-id')?.value || '';
    if (fixedServerId) {
        params.set('server_id', fixedServerId);
    } else {
        var serverId = document.getElementById('server-select')?.value || '';
        if (serverId) params.set('server_id', serverId);
    }
    if (mainDbId) params.set('main_db_id', mainDbId);
    if (keyword) params.set('keyword', keyword);
    if (status) params.set('status', status);
    
    const url = '/partials/corps/list' + (params.toString() ? '?' + params.toString() : '');
    
    // 로딩 표시
    if (loading) loading.classList.remove('hidden');
    
    // HTMX로 새로고침
    htmx.ajax('GET', url, {
        target: '#corps-table-body', 
        swap: 'innerHTML'
    }).then(function() {
        if (loading) loading.classList.add('hidden');
    });
}

// ── 검색 입력 debounce ──
document.addEventListener('DOMContentLoaded', function() {
    const keywordInput = document.getElementById('keyword-input');
    if (keywordInput) {
        keywordInput.addEventListener('input', function() {
            clearTimeout(this._debounce);
            this._debounce = setTimeout(function() {
                reloadCorpsList();
            }, 300);
        });
    }
});
</script>
{% endblock %}