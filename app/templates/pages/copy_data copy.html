{% extends "base.html" %}
{% from "components/icons.html" import svg_icon %}
{% from "components/modals.html" import confirm_modal, toast_message %}

{% block title %}데이터 복사 - DB 관리 시스템{% endblock %}

{% block content %}
<div x-data="copyDataPage()" class="space-y-6">
    <!-- 페이지 헤더 -->
    <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center text-primary-600">
            {{ svg_icon('document-duplicate', 'w-6 h-6') }}
        </div>
        <div>
            <h1 class="text-2xl font-bold text-gray-800">데이터 복사</h1>
            <p class="text-gray-500 mt-1">소스 DB의 테이블 데이터를 대상 DB로 복사합니다</p>
        </div>
    </div>
    
    <!-- 서버/DB 선택 -->
    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 relative">
            <!-- 소스 (원본) -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <span class="text-blue-500">{{ svg_icon('arrow-up-tray', 'w-5 h-5') }}</span>
                    소스 (원본)
                </h3>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">서버 선택 *</label>
                    <select id="source-server" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-primary-500"
                            @change="loadDatabases($event.target.value, 'source-db')">
                        <option value="">서버를 선택하세요</option>
                        {% for server in servers %}
                        <option value="{{ server.id }}" 
                                data-type="{{ server.server_type|default('') }}"
                                {% if source_server == server.id %}selected{% endif %}>
                            {{ server.server_name }} ({{ server.db_count }} DBs)
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">DB 선택 *</label>
                    <select id="source-db" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-primary-500">
                        <option value="">DB를 선택하세요</option>
                        {% for db in source_databases %}
                        <option value="{{ db.db_name }}" {% if source_db == db.db_name %}selected{% endif %}>
                            {{ db.db_name }} ({{ "%.1f"|format(db.size_mb) }} MB)
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- 화살표 -->
            <div class="hidden lg:flex items-center justify-center absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10">
                <span class="text-4xl text-gray-300">→</span>
            </div>
            
            <!-- 대상 (타겟) -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <span class="text-green-500">{{ svg_icon('arrow-down-tray', 'w-5 h-5') }}</span>
                    대상 (복사할 곳)
                </h3>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">서버 선택 *</label>
                    <select id="target-server" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-primary-500"
                            @change="loadDatabases($event.target.value, 'target-db'); checkTargetServer();">
                        <option value="">서버를 선택하세요</option>
                        {% for server in servers %}
                        <option value="{{ server.id }}"
                                data-type="{{ server.server_type|default('') }}"
                                data-is-prod="{{ server.is_production|default(false)|lower }}"
                                {% if target_server == server.id %}selected{% endif %}>
                            {{ server.server_name }} ({{ server.db_count }} DBs)
                        </option>
                        {% endfor %}
                    </select>
                    <!-- 운영서버 경고 배너 -->
                    <div x-show="isTargetProd" x-cloak
                         class="mt-2 p-3 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-center gap-2 text-red-700 text-sm font-medium">
                            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126z"/>
                                <path d="M12 15.75h.007v.008H12v-.008z"/>
                            </svg>
                            대상이 운영서버입니다. 데이터 복사 시 주의하세요!
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">DB 선택 *</label>
                    <select id="target-db" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-primary-500">
                        <option value="">DB를 선택하세요</option>
                        {% for db in target_databases %}
                        <option value="{{ db.db_name }}" {% if target_db == db.db_name %}selected{% endif %}>
                            {{ db.db_name }} ({{ "%.1f"|format(db.size_mb) }} MB)
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- 복사 모드 선택 -->
        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
            <label class="block text-sm font-medium text-gray-700 mb-3">복사 모드</label>
            <div class="flex flex-wrap gap-4">
                <template x-for="mode in copyModes" :key="mode.value">
                    <label class="flex items-center gap-2 cursor-pointer px-4 py-2 border rounded-lg bg-white hover:border-primary-300 transition"
                           :class="copyMode === mode.value ? 'border-primary-500 bg-primary-50' : ''">
                        <input type="radio" name="copy_mode" :value="mode.value"
                               x-model="copyMode"
                               class="text-primary-600 focus:ring-primary-500">
                        <div>
                            <span class="text-sm font-medium text-gray-800" x-text="mode.label"></span>
                            <span class="text-xs text-gray-500 block" x-text="mode.desc"></span>
                        </div>
                    </label>
                </template>
            </div>
        </div>
        
        <!-- 테이블 조회 버튼 -->
        <div class="mt-6 flex justify-center">
            <button @click="loadTables()"
                    class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition flex items-center gap-2">
                {{ svg_icon('magnifying-glass', 'w-5 h-5') }}
                테이블 조회
            </button>
        </div>
    </div>
    
    <!-- 테이블 선택 영역 -->
    <div x-show="showTables" x-cloak>
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    {{ svg_icon('table-cells', 'w-5 h-5 text-primary-600') }}
                    복사할 테이블 선택
                </h3>
                <div class="flex items-center gap-2">
                    <button @click="selectAll()" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                        전체 선택
                    </button>
                    <button @click="selectNone()" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                        전체 해제
                    </button>
                    <input type="text" 
                           placeholder="테이블 검색..."
                           class="px-3 py-1 text-sm border border-gray-300 rounded-lg"
                           @keyup="filterTables($event.target.value)">
                </div>
            </div>
            
            <div id="tables-list" class="border border-gray-200 rounded-lg overflow-hidden">
            </div>
            
            <!-- 선택 요약 -->
            <div class="mt-4 p-4 bg-gray-50 rounded-lg flex items-center justify-between">
                <div>
                    <span class="text-gray-600">선택:</span>
                    <span id="selected-count" class="font-semibold text-primary-600">0</span>개 테이블
                    (<span id="selected-rows" class="text-gray-600">0</span>행,
                    <span id="selected-size" class="text-gray-600">0</span> MB)
                </div>
                <button @click="showCopyConfirm()"
                        :disabled="!hasSelection"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2">
                    <template x-if="!copying">
                        <span class="flex items-center gap-2">
                            {{ svg_icon('rocket', 'w-5 h-5') }}
                            데이터 복사
                        </span>
                    </template>
                    <template x-if="copying">
                        <span class="flex items-center gap-2">
                            <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            복사 중...
                        </span>
                    </template>
                </button>
            </div>
        </div>
    </div>
    
    <!-- 복사 진행 상황 -->
    <div x-show="copying" x-cloak>
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center gap-4 mb-4">
                <div class="inline-block w-8 h-8 border-4 border-primary-600 border-t-transparent rounded-full animate-spin"></div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">데이터 복사 중...</h3>
                    <p class="text-sm text-gray-500" x-text="progressText"></p>
                </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-primary-600 h-2 rounded-full transition-all duration-300" :style="'width:' + progressPercent + '%'"></div>
            </div>
            <p class="text-xs text-gray-400 mt-2 text-center" x-text="progressDetail"></p>
        </div>
    </div>
    
    <!-- 복사 결과 영역 -->
    <div id="copy-result" class="hidden"></div>
    
    <!-- 확인 모달 (공통 컴포넌트) -->
    {{ confirm_modal() }}
    
    <!-- 토스트 메시지 (공통 컴포넌트) -->
    {{ toast_message() }}
</div>

<script>
function copyDataPage() {
    return {
        // 상태
        copyMode: 'truncate',
        showTables: false,
        copying: false,
        hasSelection: false,
        isTargetProd: false,
        progressText: '',
        progressDetail: '',
        progressPercent: 0,
        progressInterval: null,
        
        // 복사 모드 옵션
        copyModes: [
            { value: 'truncate', label: 'TRUNCATE 후 INSERT', desc: '대상 테이블을 비우고 복사 (권장)' },
            { value: 'delete', label: 'DELETE 후 INSERT', desc: 'FK 제약 있을 때 사용' },
            { value: 'append', label: '기존 데이터 유지', desc: '추가 적재 (중복 주의)' }
        ],
        
        // 모달 변수 (confirm_modal 매크로용)
        showConfirmModal: false,
        confirmData: {
            title: '',
            message: '',
            type: 'info',
            confirmText: '확인',
            cancelText: '취소'
        },
        
        // 토스트 변수 (toast_message 매크로용)
        toast: { show: false, message: '', type: 'success' },
        
        // 복사 실행에 필요한 임시 데이터
        _pendingCopy: null,

        // ── DB 목록 로드 ──
        loadDatabases(serverId, targetSelectId) {
            var select = document.getElementById(targetSelectId);
            if (!serverId) {
                select.innerHTML = '<option value="">DB를 선택하세요</option>';
                return;
            }
            select.innerHTML = '<option value="">로딩 중...</option>';
            
            fetch('/partials/servers/' + serverId + '/databases')
                .then(function(r) {
                    if (!r.ok) throw new Error('서버 응답 오류: ' + r.status);
                    return r.text();
                })
                .then(function(html) { select.innerHTML = html; })
                .catch((err) => {
                    select.innerHTML = '<option value="">DB 목록 로드 실패</option>';
                    this.showToast('DB 목록을 불러오지 못했습니다: ' + err.message, 'error');
                });
        },
        
        // ── 운영서버 체크 ──
        checkTargetServer() {
            var select = document.getElementById('target-server');
            var option = select.options[select.selectedIndex];
            if (!option || !option.value) {
                this.isTargetProd = false;
                return;
            }
            var serverType = (option.dataset.type || '').toLowerCase();
            var isProd = option.dataset.isProd === 'true';
            this.isTargetProd = isProd || serverType === 'production' || serverType === 'prod' || serverType === '운영';
        },
        
        // ── 테이블 조회 ──
        loadTables() {
            var sourceServer = document.getElementById('source-server').value;
            var sourceDb = document.getElementById('source-db').value;
            var targetServer = document.getElementById('target-server').value;
            var targetDb = document.getElementById('target-db').value;
            
            if (!sourceServer || !sourceDb) {
                this.showToast('소스 서버와 DB를 선택하세요', 'warning');
                return;
            }
            if (!targetServer || !targetDb) {
                this.showToast('대상 서버와 DB를 선택하세요', 'warning');
                return;
            }
            if (sourceServer === targetServer && sourceDb === targetDb) {
                this.showToast('소스와 대상이 같을 수 없습니다', 'warning');
                return;
            }
            
            this.showTables = true;
            document.getElementById('copy-result').classList.add('hidden');
            document.getElementById('tables-list').innerHTML =
                '<div class="p-8 text-center">' +
                '<div class="inline-block w-8 h-8 border-4 border-primary-600 border-t-transparent rounded-full animate-spin mb-4"></div>' +
                '<p class="text-gray-500">테이블 정보를 불러오는 중...</p></div>';
            
            htmx.ajax('GET', '/partials/copy-data/tables/' + sourceServer + '/' + sourceDb +
                '?target_server_id=' + targetServer + '&target_db_name=' + encodeURIComponent(targetDb), {
                target: '#tables-list',
                swap: 'innerHTML'
            });
        },
        
        // ── 전체 선택/해제 ──
        selectAll() {
            document.querySelectorAll('.table-checkbox:not(:disabled)').forEach(function(cb) {
                if (cb.closest('.table-row').style.display !== 'none') cb.checked = true;
            });
            this.updateSummary();
        },
        selectNone() {
            document.querySelectorAll('.table-checkbox').forEach(function(cb) { cb.checked = false; });
            this.updateSummary();
        },
        
        // ── 테이블 필터 ──
        filterTables(keyword) {
            var lk = keyword.toLowerCase();
            document.querySelectorAll('.table-row').forEach(function(row) {
                row.style.display = row.dataset.tableName.toLowerCase().indexOf(lk) >= 0 ? '' : 'none';
            });
        },
        
        // ── 선택 요약 ──
        updateSummary() {
            var cbs = document.querySelectorAll('.table-checkbox:checked');
            var totalRows = 0, totalSize = 0;
            cbs.forEach(function(cb) {
                totalRows += parseInt(cb.dataset.rows || 0);
                totalSize += parseFloat(cb.dataset.size || 0);
            });
            document.getElementById('selected-count').textContent = cbs.length;
            document.getElementById('selected-rows').textContent = totalRows.toLocaleString();
            document.getElementById('selected-size').textContent = totalSize.toFixed(2);
            this.hasSelection = cbs.length > 0;
        },
        
        // ── 복사 확인 모달 표시 ──
        showCopyConfirm() {
            var sourceDb = document.getElementById('source-db').value;
            var targetDb = document.getElementById('target-db').value;
            var tables = [];
            document.querySelectorAll('.table-checkbox:checked').forEach(function(cb) {
                tables.push(cb.value);
            });
            
            if (tables.length === 0) {
                this.showToast('복사할 테이블을 선택하세요', 'warning');
                return;
            }
            
            var modeLabel = this.copyModes.find(m => m.value === this.copyMode);
            
            // 모달 데이터 설정
            this.confirmData = {
                title: '데이터 복사 확인',
                message: '선택한 ' + tables.length + '개 테이블을 복사하시겠습니까?\n\n' +
                         '소스: ' + sourceDb + '\n' +
                         '대상: ' + targetDb + '\n' +
                         '모드: ' + (modeLabel ? modeLabel.label : this.copyMode) +
                         (this.isTargetProd ? '\n\n⚠️ 대상이 운영서버입니다!' : ''),
                type: this.isTargetProd ? 'danger' : 'warning',
                confirmText: this.isTargetProd ? '운영서버에 복사' : '복사 실행',
                cancelText: '취소'
            };
            
            // 복사 데이터 임시 저장
            this._pendingCopy = {
                source_server_id: parseInt(document.getElementById('source-server').value),
                source_db: sourceDb,
                target_server_id: parseInt(document.getElementById('target-server').value),
                target_db: targetDb,
                tables: tables,
                copy_mode: this.copyMode
            };
            
            this.showConfirmModal = true;
        },
        
        // ── 모달 확인 버튼 핸들러 (confirm_modal에서 호출) ──
        onConfirm() {
            this.executeCopy();
        },
        
        // ── 복사 실행 ──
        executeCopy() {
            if (!this._pendingCopy) return;
            var data = this._pendingCopy;
            var modeLabel = this.copyModes.find(m => m.value === data.copy_mode);
            
            this.copying = true;
            this.progressPercent = 0;
            this.progressText = data.tables.length + '개 테이블 복사를 시작합니다...';
            this.progressDetail = '모드: ' + (modeLabel ? modeLabel.label : data.copy_mode);
            
            // 시각적 진행률 애니메이션
            var self = this;
            this.progressInterval = setInterval(function() {
                if (self.progressPercent < 90) {
                    self.progressPercent += Math.random() * 5;
                    if (self.progressPercent > 90) self.progressPercent = 90;
                }
            }, 500);
            
            fetch('/partials/copy-data/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then((r) => {
                if (!r.ok) throw new Error('서버 오류: ' + r.status);
                return r.text();
            })
            .then((html) => {
                clearInterval(this.progressInterval);
                this.progressPercent = 100;
                
                setTimeout(() => {
                    this.copying = false;
                    var resultEl = document.getElementById('copy-result');
                    resultEl.innerHTML = html;
                    resultEl.classList.remove('hidden');
                    resultEl.scrollIntoView({ behavior: 'smooth' });
                }, 500);
            })
            .catch((err) => {
                clearInterval(this.progressInterval);
                this.copying = false;
                this.showToast('복사 중 오류가 발생했습니다: ' + err.message, 'error');
            });
            
            this._pendingCopy = null;
        },
        
        // ── 토스트 표시 ──
        showToast(message, type) {
            this.toast = { show: true, message: message, type: type || 'info' };
            setTimeout(() => { this.toast.show = false; }, 3000);
        }
    };
}

// tables.html에서 호출하는 전역 함수 (Alpine 스코프 브릿지)
function updateSummary() {
    var el = document.querySelector('[x-data]');
    if (el && el.__x) el.__x.$data.updateSummary();
}
function syncSelectAll() {
    var allCbs = document.querySelectorAll('.table-checkbox:not(:disabled)');
    var checkedCount = document.querySelectorAll('.table-checkbox:not(:disabled):checked').length;
    var selectAllCb = document.getElementById('select-all-checkbox');
    if (selectAllCb) {
        selectAllCb.checked = allCbs.length > 0 && checkedCount === allCbs.length;
        selectAllCb.indeterminate = checkedCount > 0 && checkedCount < allCbs.length;
    }
    updateSummary();
}
</script>
{% endblock %}