# 알림_시나리오

> **대상:** HandsDB 시스템 운영자 / DB 관리자  
> **목적:** 알림 기능의 사용 시나리오와 기능 상세를 정의합니다.  
> **최종 수정일:** 2026-02-08

---

## 1. 화면 개요

알림은 시스템 전반에서 발생하는 이벤트(서버 오류, DB 생성, 용량 경고 등)를 사용자에게 실시간으로 전달하는 기능입니다.

### 화면 구성

| 영역 | 설명 |
|------|------|
| 알림 배지 | 상단바 우측 종 아이콘 + 읽지 않은 건수 표시 |
| 알림 드롭다운 | 배지 클릭 시 최근 10건 목록 표시 |
| 전체 알림 페이지 | 전체 알림 목록 (최대 100건) + 읽음/삭제 관리 |

### 화면 URL

| URL | 설명 |
|-----|------|
| `/notifications` | 알림 드롭다운 내용 (HTMX) |
| `/notifications/badge` | 알림 배지 (30초 폴링) |
| `/notifications/all` | 전체 알림 페이지 |
| `/notifications/{id}/read` | 개별 읽음 처리 |
| `/notifications/read-all` | 전체 읽음 처리 |

---

## 2. 시나리오

### 시나리오 2-1: 알림 배지 확인

```
사용자: DB 관리자
목적: 읽지 않은 알림 여부 확인

1. 로그인 후 상단바 우측에 종 아이콘 표시
2. 배지 확인
   - 숫자 없음 → 미확인 알림 없음
   - 빨간 배지 "3" → 읽지 않은 알림 3건
   - 빨간 배지 "99+" → 100건 이상
3. 30초마다 자동 갱신 (HTMX 폴링)
   - 새 알림 발생 시 배지 숫자 증가
   - 서버 오류 등으로 조회 실패 시 빈 응답 (기존 배지 유지)

※ 로그인하지 않은 경우 배지 미표시
```

### 시나리오 2-2: 알림 드롭다운 확인

```
사용자: DB 관리자
목적: 최근 알림 빠르게 확인

1. 상단바 종 아이콘 클릭
2. 드롭다운 표시 (최근 10건)
   - 각 알림: 아이콘 + 제목 + 시간("3분 전")
   - 읽지 않은 알림: 굵은 글씨 + 배경색 강조
   - 읽은 알림: 일반 글씨
3. 알림 유형별 아이콘
   - ℹ️ info: 파란색
   - ✅ success: 초록색
   - ⚠️ warning: 주황색
   - ❌ error: 빨간색
4. "전체 읽음" 버튼 클릭 → 모든 알림 읽음 처리
5. "전체 알림 보기" 링크 → /notifications/all 이동
```

### 시나리오 2-3: 개별 알림 읽음 처리

```
사용자: DB 관리자
목적: 특정 알림 확인 후 읽음 처리

1. 드롭다운에서 알림 항목 클릭
2. 해당 알림 읽음 처리 (is_read = true)
3. 알림에 링크가 있는 경우
   - 예: link="/servers" → 서버 관리 페이지로 이동
   - 예: link="/databases?db=ACC_TEST01" → DB 상세로 이동
4. 드롭다운 목록 갱신 (읽은 알림 스타일 변경)
5. 배지 숫자 감소
```

### 시나리오 2-4: 전체 알림 페이지

```
사용자: DB 관리자
목적: 과거 알림 이력 전체 확인

1. 드롭다운 > "전체 알림 보기" 클릭
2. /notifications/all 페이지 표시
   - 최대 100건 목록
   - 읽지 않은 건수 표시: "읽지 않은 알림 5건"
3. 각 알림에서 가능한 작업
   - 읽음 처리 (개별)
   - 삭제 (개별)
   - 전체 읽음 처리
4. 알림 카테고리별 확인
   - system: 시스템 알림 (계정 승인 등)
   - server: 서버 연결 오류
   - database: DB 생성/삭제
   - capacity: 용량 임계치 초과
   - backup: 백업 완료/실패
   - copy: 데이터 복사 결과
```

### 시나리오 2-5: 시스템 이벤트 → 자동 알림 생성

```
사용자: 시스템 (자동)
목적: 주요 이벤트 발생 시 관련 사용자에게 알림

[서버 연결 오류]
1. 서버 점검 중 연결 실패 감지
2. 알림 자동 생성
   - type: error
   - category: server
   - title: "[오류] 운영서버 연결 실패"
   - link: "/servers"
3. 관리자에게 알림 전달

[DB 생성 완료]
1. 신규 법인 DB 생성 성공
2. 알림 자동 생성
   - type: success
   - category: database
   - title: "[완료] ACC_CORP073 생성됨"
   - link: "/databases"
3. 작업 요청자에게 알림 전달

[용량 경고]
1. DB 용량 모니터링 중 임계치 초과 감지
2. 알림 자동 생성
   - 80% 이상: type=warning, "[경고] ACC_TEST01 용량 85.3%"
   - 90% 이상: type=error, "[위험] ACC_TEST01 용량 93.1%"
   - link: "/databases?db=ACC_TEST01"
3. 관리자에게 알림 전달

[데이터 복사 결과]
1. 데이터 복사 작업 완료
2. 성공 시: type=success, "15개 테이블, 23,456건"
   실패 시: type=error, 오류 메시지 포함
3. 작업 요청자에게 알림 전달

[사용자 승인]
1. 신규 사용자 가입 요청
2. 관리자에게: "[승인 대기] 신규 사용자: parkdj"
   승인 후 사용자에게: "계정이 승인되었습니다"
```

### 시나리오 2-6: 오래된 알림 정리

```
사용자: 시스템 관리자
목적: 오래된 알림 자동 삭제

1. cleanup_old(days=30) 호출 (수동 또는 스케줄)
2. 30일 이전 알림 일괄 삭제
3. 삭제 건수 반환
   - "42건의 오래된 알림이 정리되었습니다"

※ 향후 스케줄러(APScheduler 등) 연동 시 자동 실행 가능
```

---

## 3. 기능 상세

### 3-1. 알림 배지 (폴링)

| 항목 | 설명 |
|------|------|
| 갱신 주기 | 30초 (HTMX `hx-trigger="every 30s"`) |
| 표시 형식 | 숫자 (1~99), 100건 이상은 "99+" |
| 비로그인 | 빈 HTML 반환 |
| 위치 | 상단바 우측 종 아이콘 옆 |

### 3-2. 알림 드롭다운

| 항목 | 설명 |
|------|------|
| 표시 건수 | 최근 10건 |
| 정렬 | 최신순 (created_at DESC) |
| 대상 범위 | 본인 알림 + 전체 알림 (user_id=NULL) |
| 읽음 구분 | 미읽음: 굵은 글씨 + 배경 강조, 읽음: 일반 |
| 액션 | 개별 읽음, 전체 읽음, 전체 페이지 이동 |

### 3-3. 알림 모델 (PostgreSQL)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | INTEGER PK | 알림 ID |
| user_id | INTEGER (nullable) | 대상 사용자 (NULL=전체) |
| title | VARCHAR(200) | 알림 제목 |
| message | TEXT | 상세 내용 |
| type | VARCHAR(20) | `info` / `success` / `warning` / `error` |
| category | VARCHAR(20) | `system` / `server` / `database` / `backup` / `copy` / `capacity` / `security` |
| resource_type | VARCHAR(50) | 관련 리소스 유형 |
| resource_id | INTEGER | 관련 리소스 ID |
| resource_name | VARCHAR(100) | 관련 리소스 이름 |
| link | VARCHAR(500) | 클릭 시 이동 URL |
| is_read | BOOLEAN | 읽음 여부 |
| read_at | DATETIME | 읽은 시각 |
| created_at | DATETIME | 생성 시각 |

인덱스: `user_id`, `is_read`, `(user_id, is_read)` 복합

### 3-4. 알림 생성 헬퍼 함수

| 함수 | 트리거 | 알림 유형 |
|------|--------|----------|
| `notify_capacity_warning()` | 용량 80%/90% 초과 | warning / error |
| `notify_backup_warning()` | 백업 미실행 경과 | warning |
| `notify_server_error()` | 서버 연결 실패 | error |
| `notify_copy_complete()` | 데이터 복사 성공 | success |
| `notify_copy_failed()` | 데이터 복사 실패 | error |
| `notify_db_created()` | DB 생성 완료 | success |
| `notify_user_approved()` | 계정 승인 완료 | success |
| `notify_new_user_pending()` | 신규 사용자 승인 대기 | info |

### 3-5. 데이터 저장소 변경 이력

| 버전 | 저장소 | 비고 |
|------|--------|------|
| v1.0 | SQLite (`app/data/notifications.db`) | 로컬 전용 |
| v1.2 | **PostgreSQL** (`handsdb.notifications`) | 클라우드 서비스 구조 지원 |

변경 사유: 다중 기기 동기화, Docker 재빌드 시 데이터 유실 방지, 사용자 테이블과 동일 DB 관리

---

## 4. 데이터 흐름

### 4-1. 알림 생성 흐름

```
시스템 이벤트 발생
  │ (서버 오류, DB 생성, 용량 초과 등)
  ▼
헬퍼 함수 호출 (notification_service.py)
  │ notify_server_error(db, server_name, ...)
  ▼
NotificationService.create()
  │ INSERT INTO notifications (...)
  ▼
PostgreSQL notifications 테이블 저장
  ▼
다음 배지 폴링(30초) 시 사용자에게 표시
```

### 4-2. 알림 조회 흐름

```
상단바 배지 (30초 폴링)
  │ GET /notifications/badge
  ▼
get_unread_count(user_id)
  │ SELECT COUNT(*) WHERE user_id=? AND is_read=false
  ▼
배지 HTML 반환 ("3" 또는 "")

드롭다운 (클릭 시)
  │ GET /notifications
  ▼
get_list(user_id, limit=10)
  │ SELECT * WHERE user_id=? OR user_id IS NULL ORDER BY created_at DESC
  ▼
드롭다운 HTML 반환 (HTMX)
```

---

## 5. 관련 파일

### 백엔드

| 파일 | 경로 | 설명 |
|------|------|------|
| notification_db.py | `app/core/` | DB 연결 설정 (PostgreSQL 위임) |
| notification.py | `app/models/` | Notification 모델 (ORM) |
| notification_service.py | `app/services/` | 알림 CRUD + 헬퍼 함수 |
| notifications.py | `app/routers/` | 알림 API 라우터 |

### 프론트엔드

| 파일 | 경로 | 설명 |
|------|------|------|
| base.html | `app/templates/` | 상단바 알림 배지 (HTMX 폴링) |
| notification_dropdown.html | `app/templates/components/` | 드롭다운 UI |
| notifications.html | `app/templates/pages/` | 전체 알림 페이지 |

### API 엔드포인트

| 메서드 | URL | 설명 |
|--------|-----|------|
| GET | `/notifications` | 드롭다운 내용 (HTMX) |
| GET | `/notifications/badge` | 배지 (폴링용) |
| GET | `/notifications/all` | 전체 알림 페이지 |
| POST | `/notifications/{id}/read` | 개별 읽음 처리 |
| POST | `/notifications/read-all` | 전체 읽음 처리 |
| DELETE | `/notifications/{id}` | 알림 삭제 |

---

## 6. 시나리오 요약표

| # | 시나리오 | 주요 기능 | 사용 빈도 |
|---|---------|-----------|----------|
| 2-1 | 알림 배지 확인 | 30초 폴링, 미읽음 건수 | 상시 (자동) |
| 2-2 | 드롭다운 확인 | 최근 10건, 유형별 아이콘 | 수시 |
| 2-3 | 개별 읽음 처리 | 읽음 + 링크 이동 | 수시 |
| 2-4 | 전체 알림 페이지 | 100건 목록, 삭제 | 필요 시 |
| 2-5 | 자동 알림 생성 | 서버오류/DB생성/용량경고 | 이벤트 발생 시 |
| 2-6 | 오래된 알림 정리 | 30일 이전 자동 삭제 | 스케줄/수동 |