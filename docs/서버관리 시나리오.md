# HandsDB 서버 관리 시나리오

> 프로세스 관점의 서버 관리 운영 시나리오 문서  
> 작성일: 2025-02-08  
> 대상 시스템: HandsDB (Corp DB Manager)

---

## 1. 시스템 구성 개요

### 1.1 아키텍처

```
┌─────────────────────────────────────────────────────┐
│                    사용자 브라우저                      │
│         (Alpine.js + HTMX + Tailwind CSS)            │
└───────────────────────┬─────────────────────────────┘
                        │ HTTP
┌───────────────────────▼─────────────────────────────┐
│                 FastAPI 서버 (Uvicorn)                │
│  ┌──────────┐  ┌──────────┐  ┌───────────────────┐  │
│  │ pages.py │  │servers.py│  │  server_service.py │  │
│  │ (HTML    │  │ (REST    │  │  (비즈니스 로직)    │  │
│  │  렌더링)  │  │   API)   │  │                   │  │
│  └──────────┘  └──────────┘  └───────────────────┘  │
│       │              │               │                │
│  ┌────▼──────────────▼───────────────▼────────────┐  │
│  │              auth.py (인증 미들웨어)              │  │
│  └────┬──────────────────────────────┬────────────┘  │
│       │                              │                │
│  ┌────▼────────┐            ┌────────▼──────────┐    │
│  │   SQLite    │            │    PostgreSQL      │    │
│  │ (메타 데이터) │            │  (사용자 인증)      │    │
│  │ - 서버 정보  │            │  - 사용자 계정      │    │
│  │ - 법인 정보  │            │  - 이메일 인증      │    │
│  │ - 활동 로그  │            │  - 역할/권한        │    │
│  └─────────────┘            └───────────────────┘    │
└─────────────────────────────────────────────────────┘
```

### 1.2 인증 체계

| 구분 | 저장소 | 용도 |
|------|--------|------|
| 사용자 인증 | PostgreSQL (`PgUser`) | 로그인, 회원가입, 이메일 인증, 역할 관리 |
| 메타 데이터 | SQLite (`DBServer`, `Corp`) | 서버 정보, 법인 DB 정보, 활동 로그 |

#### 인증 흐름

```
로그인 요청 → PostgreSQL에서 사용자 조회 → JWT 토큰 발급 (쿠키)
     ↓
API 호출 → require_login() → JWT 디코딩 → PostgreSQL에서 사용자 확인
     ↓
서버 데이터 조회 → SQLite에서 전체 서버 목록 반환 (사용자 구분 없음)
```

> **핵심:** 서버 목록은 모든 로그인 사용자에게 동일하게 표시됩니다. 서버 데이터는 SQLite에 저장되며 사용자별 분리 없이 로컬 기준으로 공유됩니다.

### 1.3 사용자 역할 및 권한

| 역할 | 서버 조회 | 연결 테스트 | 서버 등록/수정/삭제 | DB 생성 | 사용자 관리 |
|------|----------|-----------|------------------|--------|-----------|
| admin | ✅ | ✅ | ✅ | ✅ | ✅ |
| operator | ✅ | ✅ | ❌ | ✅ | ❌ |
| viewer | ✅ | ✅ | ❌ | ❌ | ❌ |

---

## 2. 서버 관리 페이지 접근 프로세스

### 2.1 페이지 로딩 흐름

```
사용자가 /servers 접근
     │
     ▼
[pages.py] servers_page()
     │
     ├─ get_current_user_any() → PostgreSQL 우선, SQLite 폴백
     │   ├─ 인증 실패 → /login 리다이렉트
     │   └─ 인증 성공 → user 객체 반환
     │
     └─ servers.html 렌더링 (서버 데이터 없이 빈 페이지)
          │
          ▼
     [프론트엔드] Alpine.js init()
          │
          ├─ ① fetch('/api/servers?fast=true')
          │   └─ 연결 테스트 없이 빠른 서버 목록 반환
          │   └─ 서버 카드 그리드 렌더링
          │
          └─ ② checkAllConnectionsAsync() (백그라운드)
              └─ 각 서버별 POST /api/servers/{id}/test 병렬 실행
              └─ 카드별 상태 인디케이터 업데이트 (🟢/🔴/⚪)
```

#### 성능 개선 포인트

| 항목 | 개선 전 | 개선 후 |
|------|---------|---------|
| 페이지 로딩 | 서버 N개 × 연결 테스트 (최대 10초/건) | 즉시 렌더링 (0.1초 이내) |
| 연결 상태 확인 | 동기 실행 (순차 대기) | 비동기 병렬 실행 (백그라운드) |
| 오프라인 서버 영향 | 타임아웃만큼 전체 블로킹 | 해당 카드만 지연, 나머지 정상 |

### 2.2 API 엔드포인트 요약

| 메서드 | 경로 | 권한 | 설명 |
|--------|------|------|------|
| GET | `/api/servers?fast=true` | login | 서버 목록 (연결 테스트 생략) |
| GET | `/api/servers` | login | 서버 목록 (연결 테스트 포함) |
| GET | `/api/servers/{id}` | login | 서버 상세 |
| POST | `/api/servers` | admin | 서버 등록 |
| PUT | `/api/servers/{id}` | admin | 서버 수정 |
| DELETE | `/api/servers/{id}` | admin | 서버 삭제 |
| POST | `/api/servers/{id}/test` | login | 연결 테스트 (ID 기반) |
| POST | `/api/servers/test-connection` | 없음 | 연결 테스트 (직접 정보) |

---

## 3. 서버 등록 시나리오

### 3.1 신규 서버 등록 프로세스

```
[관리자] "서버 추가" 버튼 클릭
     │
     ▼
서버 추가 모달 열림
     │
     ├─ 필수 입력: 서버명, DB 종류, 호스트, 접속 계정, 비밀번호
     ├─ 선택 입력: 포트(자동), 기본 DB, 설명
     │
     ▼
DB 종류 선택 시 자동 처리
     ├─ MSSQL     → 포트: 1433, 기본DB: master
     ├─ PostgreSQL → 포트: 5432, 기본DB: postgres
     ├─ MySQL     → 포트: 3306, 기본DB: (비움)
     └─ Oracle    → 포트: 1521, Service Name: ORCL
     │
     ▼
[권장] "저장 전 연결 확인" → 연결 테스트 버튼 클릭
     │
     ├─ 신규: POST /api/servers/test-connection (직접 정보)
     │   └─ 성공 시: ✅ 연결 성공 + DB 버전 표시
     │   └─ 실패 시: ❌ 에러 메시지 표시
     │
     ▼
"저장" 버튼 클릭
     │
     ├─ POST /api/servers
     │   ├─ 서버명 중복 체크
     │   ├─ DB 저장 (SQLite)
     │   └─ 활동 로그 기록
     │
     ▼
서버 목록 새로고침 + 연결 상태 비동기 체크
```

### 3.2 입력 필드 상세

| 필드 | 필수 | 설명 | 예시 |
|------|------|------|------|
| 서버명 | ✅ | 고유 식별 이름 | 운영서버, 개발서버 |
| DB 종류 | ✅ | 지원 DB 타입 | mssql, postgresql, mysql, oracle |
| 호스트 | ✅ | IP 또는 도메인 | 192.168.1.100, db.example.com |
| 포트 | - | DB 종류별 자동 설정 | 1433, 5432, 3306, 1521 |
| 기본 DB | - | 연결 테스트용 DB | master, postgres, ORCL |
| 접속 계정 | ✅ | DB 계정 | sa, postgres, root |
| 비밀번호 | ✅ | DB 비밀번호 | (수정 시에는 선택) |
| 설명 | - | 서버 용도 메모 | ERP 운영 DB서버 |

### 3.3 주의사항

- 서버명은 시스템 전체에서 **유일**해야 합니다
- Oracle의 경우 기본 DB 필드가 **Service Name** 역할을 하며, 필수입니다
- 비밀번호는 SQLite에 **평문 저장**되므로 운영 환경에서는 암호화 적용이 필요합니다
- 연결 테스트는 저장 전에 수행하는 것을 권장하지만, 필수는 아닙니다

---

## 4. 서버 수정 시나리오

### 4.1 서버 정보 수정 프로세스

```
[관리자] 서버 카드 → 더보기(⋮) → "수정" 클릭
     │
     ▼
수정 모달 열림 (기존 정보 프리필)
     │
     ├─ 비밀번호: 빈칸 (변경 시에만 입력)
     │
     ▼
[선택] 연결 테스트
     │
     ├─ 비밀번호 미입력 시: POST /api/servers/{id}/test (기존 저장된 비밀번호 사용)
     ├─ 비밀번호 입력 시: POST /api/servers/test-connection (새 정보로 테스트)
     │
     ▼
"저장" 버튼 클릭
     │
     ├─ PUT /api/servers/{id}
     │   ├─ 비밀번호 미입력 → 기존 비밀번호 유지
     │   ├─ 비밀번호 입력 → 새 비밀번호로 변경
     │   └─ 활동 로그 기록
     │
     ▼
서버 목록 새로고침
```

### 4.2 수정 가능 필드

| 필드 | 수정 가능 | 비고 |
|------|----------|------|
| 서버명 | ✅ | 중복 체크 적용 |
| DB 종류 | ✅ | 포트 자동 변경 |
| 호스트 | ✅ | |
| 포트 | ✅ | |
| 기본 DB | ✅ | |
| 접속 계정 | ✅ | |
| 비밀번호 | ✅ | 빈칸이면 기존 유지 |
| 설명 | ✅ | |

---

## 5. 서버 삭제 시나리오

### 5.1 서버 삭제 프로세스

```
[관리자] 서버 카드 → 더보기(⋮) → "삭제" 클릭
     │
     ▼
삭제 확인 모달 표시
     ├─ 서버명 표시
     └─ 경고: "이 서버에 연결된 모든 설정이 함께 삭제됩니다."
     │
     ▼
"삭제" 확인
     │
     ├─ DELETE /api/servers/{id}
     │   ├─ 법인 DB 존재 여부 확인
     │   │   ├─ 있음 → 400 에러: "서버에 N개의 법인 DB가 있어 삭제할 수 없습니다."
     │   │   └─ 없음 → 삭제 진행
     │   └─ 활동 로그 기록
     │
     ▼
서버 목록 새로고침
```

### 5.2 삭제 제약조건

| 조건 | 삭제 가능 | 설명 |
|------|----------|------|
| 법인 DB 없음 | ✅ | 정상 삭제 |
| 법인 DB 존재 | ❌ | 법인 DB 먼저 삭제/이전 필요 |

> **운영 팁:** 서버를 삭제하기 전에 해당 서버의 법인 DB를 모두 다른 서버로 이전하거나 삭제해야 합니다.

---

## 6. 연결 테스트 시나리오

### 6.1 개별 연결 테스트

```
[사용자] 서버 카드 하단 → "연결 테스트" 클릭
     │
     ▼
POST /api/servers/{id}/test
     │
     ├─ ServerService.test_connection(server)
     │   ├─ DB 종류별 드라이버로 연결 시도
     │   │   ├─ MSSQL: pyodbc (ODBC Driver 17)
     │   │   ├─ PostgreSQL: psycopg2
     │   │   ├─ MySQL: pymysql
     │   │   └─ Oracle: oracledb
     │   │
     │   ├─ 성공 → 버전 정보 조회 (SELECT @@VERSION 등)
     │   └─ 실패 → 에러 메시지 반환
     │
     ▼
카드 하단에 결과 표시
     ├─ 성공: 초록색 배경 + "연결 성공" + DB 버전
     └─ 실패: 빨간색 배경 + 에러 메시지
     │
     ▼
상태 인디케이터 업데이트 (🟢 또는 🔴)
```

### 6.2 전체 일괄 연결 테스트

```
[사용자] 상단 "전체 연결 테스트" 버튼 클릭
     │
     ▼
순차 실행 시작 (동시 부하 방지)
     │
     ├─ 서버 1: POST /api/servers/1/test → 결과 반영 → 진행률 (1/N)
     ├─ 서버 2: POST /api/servers/2/test → 결과 반영 → 진행률 (2/N)
     ├─ ...
     └─ 서버 N: POST /api/servers/N/test → 결과 반영 → 진행률 (N/N)
     │
     ▼
완료 토스트 메시지
     ├─ 전체 정상: "전체 N개 서버 연결 정상" (성공)
     └─ 일부 실패: "X개 정상 / Y개 연결 실패" (경고)
```

### 6.3 백그라운드 연결 상태 체크

페이지 로딩 직후 자동 실행되는 비동기 체크입니다.

```
페이지 로딩 완료
     │
     ▼
checkAllConnectionsAsync()
     │
     ├─ Promise.allSettled() 으로 모든 서버 병렬 체크
     │   ├─ 서버 1: checking → 🟢 online
     │   ├─ 서버 2: checking → 🔴 offline
     │   └─ 서버 3: checking → 🟢 online
     │
     ▼
필터 카운트 자동 업데이트
     └─ 온라인(2) / 오프라인(1) / 미확인(0)
```

### 6.4 연결 실패 시 주요 원인

| 증상 | 원인 | 해결 방법 |
|------|------|----------|
| Connection Timeout | 호스트/포트 접근 불가 | 방화벽 확인, IP/포트 확인 |
| Login Failed | 계정/비밀번호 오류 | 인증 정보 재확인 |
| Driver Not Found | DB 드라이버 미설치 | `pip install pyodbc/psycopg2-binary/pymysql/oracledb` |
| Database Not Found | 기본 DB명 오류 | 기본 DB 필드 수정 |
| SSL/TLS Error | 인증서 문제 | `TrustServerCertificate=yes` 확인 (MSSQL) |

---

## 7. 필터링 시나리오

### 7.1 DB 종류 필터

```
필터 바: [전체] [MSSQL] [POSTGRESQL] [MYSQL] [ORACLE]
     │
     ├─ "MSSQL" 클릭 → MSSQL 서버만 표시
     ├─ "전체" 클릭 → 필터 해제
     └─ 사용 가능한 DB 종류만 버튼으로 표시 (등록된 서버 기준)
```

### 7.2 상태 필터

```
필터 바: [전체] [🟢 온라인(3)] [🔴 오프라인(1)] [미확인(0)]
     │
     ├─ "오프라인" 클릭 → 연결 실패 서버만 표시
     ├─ "온라인" 클릭 → 연결 성공 서버만 표시
     └─ 카운트는 실시간 업데이트 (연결 테스트 결과 반영)
```

### 7.3 필터 조합

DB 종류와 상태 필터는 **AND 조건**으로 동작합니다.

```
예시: MSSQL + 오프라인 → MSSQL 서버 중 연결 실패인 것만 표시
```

필터 결과가 없을 경우 "필터 조건에 맞는 서버가 없습니다." + "필터 초기화" 버튼이 표시됩니다.

---

## 8. 서버 선택 및 대시보드 이동 시나리오

### 8.1 서버 선택 프로세스

```
[사용자] 서버 카드 영역 클릭 (카드 상단부)
     │
     ▼
selectServer(server)
     │
     ├─ currentServerId = server.id
     ├─ currentServerName = server.server_name
     │
     ▼
window.location.href = '/dashboard/{server_id}'
     │
     ▼
대시보드 페이지로 이동
     └─ 해당 서버의 법인 DB 목록, 통계 표시
```

### 8.2 현재 선택된 서버 표시

선택된 서버가 있을 경우 페이지 상단에 강조 배너가 표시됩니다.

```
┌─────────────────────────────────────────────┐
│ ✅ 현재 선택된 서버                           │
│    운영서버                   [대시보드로 이동] │
└─────────────────────────────────────────────┘
```

---

## 9. 에러 처리 시나리오

### 9.1 인증 에러

| 상황 | HTTP 코드 | 처리 |
|------|-----------|------|
| 토큰 없음 | 401 | /login 리다이렉트 |
| 토큰 만료 | 401 | /login 리다이렉트 |
| 권한 부족 (등록/수정/삭제) | 403 | "관리자 권한이 필요합니다" |

### 9.2 데이터 에러

| 상황 | HTTP 코드 | 처리 |
|------|-----------|------|
| 서버명 중복 | 400 | "이미 존재하는 서버명입니다" |
| 서버 미존재 | 404 | "서버를 찾을 수 없습니다" |
| 법인 DB 존재 시 삭제 | 400 | "서버에 N개의 법인 DB가 있어 삭제할 수 없습니다" |

### 9.3 네트워크 에러

| 상황 | 처리 |
|------|------|
| API 호출 실패 | 토스트: "저장 중 오류가 발생했습니다" |
| 연결 테스트 실패 | 카드 하단: 빨간색 에러 메시지 |
| 서버 목록 로드 실패 | 콘솔 에러 로그 |

---

## 10. 데이터 흐름 정리

### 10.1 서버 데이터 저장 구조 (SQLite)

```sql
CREATE TABLE db_servers (
    id          INTEGER PRIMARY KEY,
    server_name VARCHAR(100) NOT NULL,      -- 서버 식별 이름
    host        VARCHAR(200) NOT NULL,      -- 접속 주소
    port        INTEGER DEFAULT 1433,       -- 접속 포트
    db_type     VARCHAR(20) DEFAULT 'mssql',-- DB 종류
    username    VARCHAR(100) NOT NULL,      -- DB 계정
    password    VARCHAR(200) NOT NULL,      -- DB 비밀번호
    default_db  VARCHAR(100) DEFAULT 'master', -- 기본 DB
    data_path   VARCHAR(500),               -- 데이터 파일 경로
    log_path    VARCHAR(500),               -- 로그 파일 경로
    description TEXT,                       -- 설명
    is_active   BOOLEAN DEFAULT TRUE,       -- 활성 여부
    created_at  DATETIME,
    updated_at  DATETIME
);
```

### 10.2 서버 목록 조회 흐름

```
GET /api/servers?fast=true
     │
     ▼
require_login() → PostgreSQL에서 사용자 인증
     │
     ▼
ServerService(db) → SQLite 세션
     │
     ▼
get_all_server_summaries_fast()
     │
     ├─ SELECT * FROM db_servers WHERE is_active = 1 ORDER BY server_name
     ├─ 각 서버별 Corp 카운트 조회 (warning/error)
     └─ 연결 테스트 생략 (status = UNKNOWN)
     │
     ▼
List[ServerSummary] 반환
```

### 10.3 활동 로그 기록

서버 등록/수정/삭제 시 `activity_logs` 테이블에 기록됩니다.

| action | target_type | 설명 |
|--------|------------|------|
| CREATE | SERVER | 서버 등록 |
| UPDATE | SERVER | 서버 정보 수정 |
| DELETE | SERVER | 서버 삭제 |

---

## 11. 운영 체크리스트

### 11.1 일상 점검

- [ ] 서버 관리 페이지 접속 → 전체 연결 테스트 실행
- [ ] 오프라인 서버 확인 → 원인 파악 (네트워크, DB 서비스, 계정 만료)
- [ ] 필터에서 "오프라인" 클릭 → 문제 서버만 집중 확인

### 11.2 서버 등록 시

- [ ] 호스트/포트 접근 가능 확인 (방화벽)
- [ ] DB 계정 및 권한 확인
- [ ] 모달 내 연결 테스트 성공 확인 후 저장
- [ ] DB 버전 정보가 정상적으로 반환되는지 확인

### 11.3 장애 대응

- [ ] 오프라인 서버 발견 시 → 개별 연결 테스트로 에러 메시지 확인
- [ ] "Connection Timeout" → 네트워크/방화벽 점검
- [ ] "Login Failed" → DB 계정 비밀번호 변경 여부 확인 → 서버 수정에서 비밀번호 갱신
- [ ] "Driver Not Found" → 서버에 해당 DB 드라이버 설치 확인

### 11.4 보안 권장사항

- [ ] DB 접속 비밀번호 암호화 적용 (현재 평문 저장)
- [ ] 최소 권한 원칙: DB 계정에 필요한 권한만 부여
- [ ] 주기적 비밀번호 변경 정책 수립
- [ ] SQLite 파일 접근 권한 제한 (파일 시스템 레벨)

---

## 12. 향후 개선 고려사항

| 우선순위 | 항목 | 설명 |
|---------|------|------|
| 🔴 높음 | DB 비밀번호 암호화 | SQLite 내 비밀번호 AES 암호화 저장 |
| 🔴 높음 | ActivityLog 사용자 연동 | PgUser.id와 SQLite ActivityLog.user_id 정합성 |
| 🟡 중간 | 서버 카드에 운영 정보 표시 | DB 수, 총 용량, 경고/에러 카운트 |
| 🟡 중간 | 서버 그룹/태그 기능 | 운영/개발/스테이징 구분 |
| 🟢 낮음 | 연결 상태 주기적 폴링 | 30초~1분 간격 자동 갱신 |
| 🟢 낮음 | 서버 정렬 옵션 | 이름순, 등록일순, 상태순 |