# 신규 법인 DB 생성 - 사용 시나리오

> **화면 경로:** DB 관리 시스템 → DB 관리 → DB 생성  
> **URL:** `/db/create/{server_id}`  
> **권한:** operator 이상  
> **버전:** v1.3.1 (2026-02-08)

---

## 화면 구성

### 2단계 프로세스

```
┌─────────────────────────────────────────────────────────────┐
│  ① 법인 선택                ──────────  ② SQL 확인 및 실행  │
│  (step1_corp_select)                   (step2_sql_preview)  │
└─────────────────────────────────────────────────────────────┘
```

### 1단계 구성 요소
- 법인 정보 조회 설정 (메인 DB 연결) — 페이지 진입 시 자동 로드
- 법인 목록 (조회 결과) — 설정 존재 시 자동 조회
- 신규 법인 정보 카드 (선택 시 표시)
- 참조 법인 (소스) / 생성 대상 (타겟) 2컬럼 레이아웃
- 타겟 서버 기본 선택 (현재 서버)

### 2단계 구성 요소
- SQL 편집기 (수정 가능)
- DB 옵션 설정 (읽기 전용, 접이식)
- 아이콘 프리렌더 (`<template>` + `getIcon()` 헬퍼)
- 실행 확인 모달 (DB 중복 검사 포함)
- 생성 결과: 4컬럼 (DB명/서버/테이블 수/소요시간)

---

## 시나리오 1: 일반적인 신규 법인 DB 생성

### 배경
```
사용자: 시스템 관리자 (admin)
목적: 신규 계약 법인의 회계 DB 생성
전제: 설정 페이지에서 메인 DB 연결 정보가 저장되어 있음
```

### 진행

```
1. 좌측 메뉴에서 "DB 생성" 클릭
2. 페이지 진입 시 자동 처리
   - autoLoadMainDbSettings() 호출 → /api/settings/main-db
   - 서버, DB명, 테이블명, 컬럼 매핑 자동 채우기
   - 설정값이 충분하면 fetchCorpList() 자동 호출
   - 법인 목록 테이블 표시 (법인코드, 법인명, 사업자번호, 회계DB명, 상태)

3. 법인 목록에서 "DB 미생성 법인만 표시" 체크
   - 미생성 법인만 필터링됨
   - 검색창에 법인명/코드 입력으로 추가 필터링 가능

4. 신규 법인 선택 (라디오 버튼 클릭)
   - 신규 법인 정보 카드 표시 (법인코드, 법인명, 사업자번호, 생성될 DB명)
   - 참조 법인 드롭다운에 기존 운영 법인 목록 자동 갱신

5. 참조 법인(소스) 설정
   - 드롭다운에서 기존 운영 법인 선택 (예: "1000 - 본사법인 (ACC_1000)")
   - 참조 DB 정보 표시 (DB명, 서버, 상태: 운영중)
   - hidden 필드에 소스 서버/DB 정보 자동 설정

6. 생성 대상(타겟) 서버 선택
   - 현재 서버가 기본 선택되어 있음 (v1.3.1)
   - 필요시 다른 서버 선택 가능
   - 생성될 DB명은 메인 DB에서 가져온 회계DB명으로 자동 표시

7. [SQL 미리보기] 버튼 활성화 → 클릭
   - API 호출: POST /partials/corps/generate-sql (await request.json())
   - 응답으로 생성 SQL 수신
   - 2단계로 자동 이동

8. SQL 편집기에서 생성 SQL 확인
   - CREATE DATABASE 구문 (파일 경로, 크기, 증가 단위)
   - 필요시 SQL 직접 수정 가능
   - DB 옵션 설정 섹션 펼쳐서 확인 (RECOVERY SIMPLE, Query Store ON 등)

9. [실행] 버튼 클릭
   - DB 중복 검사 자동 실행 (GET /partials/corps/check-db-exists)
   - 중복 있으면 → 토스트 에러 "DB 'xxx'이(가) 대상 서버에 이미 존재합니다." → 모달 미표시
   - 중복 없으면 → 확인 모달 표시
   - 모달 실행 버튼 활성화 상태 보장 (이전 실행에서 비활성화됐을 수 있음)

10. 모달에서 [실행] 클릭
    - 모달 실행 버튼 + 메인 실행 버튼 모두 비활성화 (더블 클릭 방지)
    - "생성 중..." 로딩 표시
    - SQL 키워드 검증 (서버단: FORBIDDEN_KEYWORDS 10종 차단)
    - API 호출: POST /partials/corps/execute-sql
    - 활동 로그 기록: details에 실행 SQL 500자 저장

11. 생성 완료 화면 표시
    - 성공 헤더: "DB 생성 완료 (198개 테이블, 5462개 설명 복제)"
    - 생성 정보 4컬럼: DB명, 서버, 테이블 수, 소요시간
    - 경고 사항 표시 (있을 경우)

12. 후속 작업 선택
    - [테스트] 버튼: 생성된 DB 연결 테스트 (driver.get_tables() 사용)
    - [테이블 초기화 → 진행]: 기준 데이터 복사 페이지 이동
    - DB 목록 / 다른 법인 생성 링크
```

---

## 시나리오 2: 설정 미등록 상태에서 수동 입력

### 배경
```
사용자: 시스템 관리자 (admin)
목적: 설정 페이지에 메인 DB 정보가 없는 상태에서 법인 생성
```

### 진행

```
1. DB 생성 페이지 진입
   - autoLoadMainDbSettings() 호출 → 설정값 없음 → catch에서 무시
   - 빈 화면 표시

2. 메인 DB 연결 정보 수동 입력
   - 서버: 드롭다운에서 선택
   - DB명: 직접 입력 (예: "NXUNIES_2601123")
   - 테이블명: 직접 입력 (예: "COMS_CMPNY")
   - 컬럼 매핑: "컬럼 매핑 설정" 접이식 펼쳐서 확인/수정
     - 법인코드 컬럼: CORP_CD (기본값)
     - 법인명 컬럼: CORP_NM (기본값)
     - 사업자번호 컬럼: SAUPNO (기본값)
     - 회계DB명 컬럼: ACC_DB_NAME (기본값)

3. [법인 목록 조회] 버튼 클릭
   - API 호출: POST /api/corps/fetch-from-main-db
   - 로딩 스피너 표시
   - 법인 목록 테이블 표시

4. 이후 시나리오 1의 4번부터 동일하게 진행

※ [설정에서 불러오기] 버튼 클릭 시
   - /api/settings/main-db 호출
   - 설정에 저장된 값을 불러와 자동 채움
   - 토스트 메시지: "설정을 불러왔습니다."
```

---

## 시나리오 3: DB 중복 생성 시도

### 배경
```
사용자: 운영 담당자 (operator)
목적: 이미 존재하는 DB명으로 생성 시도
```

### 진행

```
1. 법인 선택 및 SQL 미리보기까지 정상 진행
2. [실행] 버튼 클릭
3. showExecuteModal() 내에서 DB 중복 검사 실행
   - API: GET /partials/corps/check-db-exists?server_id=1&db_name=ACC_TEST
   - 응답: { "exists": true }
4. 토스트 메시지 표시 (빨간색)
   - "DB 'ACC_TEST'이(가) 대상 서버에 이미 존재합니다."
5. 모달 표시되지 않음 → 사용자가 법인 선택을 변경하거나 SQL을 수정해야 함

※ 중복 검사 API 실패 시 (네트워크 오류 등)
   - console.warn 출력
   - 경고만 표시하고 계속 진행 허용 (사용성 우선)
```

---

## 시나리오 4: SQL에 위험 명령어 포함

### 배경
```
사용자: 시스템 관리자 (admin)
목적: SQL 편집기에서 DROP TABLE 등 위험 명령 실행 시도
```

### 진행

```
1. SQL 미리보기 화면까지 정상 진행
2. SQL 편집기에서 내용 수정
   - DROP DATABASE [ACC_OLD] 추가
3. [실행] → DB 중복 검사 통과 → 모달 확인 → [실행] 클릭
4. 서버단 검증 (partials.py execute_corp_sql)
   - custom_sql.upper()에서 FORBIDDEN_KEYWORDS 매칭
   - 매칭 발견 시 즉시 반환:
     { "success": false, "error": "보안: 허용되지 않는 SQL 명령어가 포함되어 있습니다 (DROP DATABASE)" }
5. 토스트 메시지: 에러 표시
6. 실행 버튼 + 모달 버튼 원복 (disabled 해제)
7. SQL 편집기에서 위험 명령 제거 후 재시도 가능

차단 대상 키워드 (10종):
- DROP DATABASE, DROP TABLE, DROP SCHEMA
- TRUNCATE, xp_cmdshell, sp_configure
- SHUTDOWN, RECONFIGURE, OPENROWSET, OPENDATASOURCE
```

---

## 시나리오 5: 생성 중 오류 발생

### 배경
```
사용자: 시스템 관리자 (admin)
목적: DB 생성 과정에서 오류 발생 시 대응
```

### 진행

```
1. SQL 실행 진행
2. corp_service.create_corp_db_with_sql() 내부에서 단계별 처리

3-A. 치명적 오류 (STEP 1~5: DB생성/계정/스키마 실패)
   - _rollback_db() 자동 실행
     - ALTER DATABASE [{db_name}] SET SINGLE_USER WITH ROLLBACK IMMEDIATE
     - DROP DATABASE [{db_name}]
     - DROP LOGIN [{db_name}_user]  (v1.3.1 추가)
   - 콘솔 로그: "🔄 롤백 완료: DB [ACC_TEST], 로그인 [ACC_TEST_user] 삭제"
   - 롤백 실패 시: "⚠️ 롤백 중 오류 (수동 정리 필요): {에러}" (v1.3.1 추가)
   - 에러 결과 반환 → partials.py에서 사용자 친화적 메시지 매핑

3-B. 비치명적 오류 (STEP 5.5~9: 확장속성/인덱스/데이터/관리자/메타)
   - 생성 완료로 처리
   - warnings 배열에 경고 메시지 추가
   - 성공 화면에 경고 섹션 표시

에러 메시지 매핑 (partials.py):
- "already exists" → "DB '...'이(가) 이미 존재합니다."
- "permission/denied" → "DB 생성 권한이 없습니다. 관리자에게 문의하세요."
- "disk/space" → "디스크 공간이 부족합니다."
- "path/directory" → "파일 경로가 올바르지 않습니다. 서버 설정을 확인하세요."
- "timeout" → "작업 시간이 초과되었습니다. 다시 시도하세요."
- "connection" → "서버 연결에 실패했습니다. 서버 상태를 확인하세요."
- 기타 → "DB 생성 중 오류가 발생했습니다." (detail 필드에 원본 에러 포함)
```

---

## 시나리오 6: 생성 완료 후 후속 작업

### 배경
```
사용자: 시스템 관리자 (admin)
목적: DB 생성 후 연결 테스트 및 테이블 초기화 진행
```

### 진행

```
1. DB 생성 완료 화면
   - 성공 헤더: "DB 생성 완료 (198개 테이블, 5462개 설명 복제)"
   - 4컬럼 정보: DB명 (ACC_TEST) / 서버 (운영서버) / 테이블 (198개) / 소요시간 (60초)

2. [테스트] 버튼 클릭
   - API 호출: POST /partials/corps/test-created-db
   - 내부: driver.get_tables(db_name) 사용 (MSSQL/PostgreSQL/Oracle 호환)
   - 성공 시: 버튼 녹색 변경 + "198개 테이블 확인" 표시
   - 실패 시: 버튼 빨간색 + 에러 메시지 → 3초 후 [재시도] 버튼 전환

3. [테이블 초기화 → 진행] 클릭
   - /db/table-init/{server_id} 페이지로 이동
   - 소스 DB에서 기준 데이터(공통코드, 메뉴, 권한 등) 복사

4. 또는 하단 링크 선택
   - "DB 목록": /db/list/{server_id} 이동
   - "다른 법인 생성": /db/create/{server_id} 이동 (새로고침)
```

---

## 시나리오 7: SQL 다운로드

### 배경
```
사용자: 시스템 관리자 (admin)
목적: 생성 SQL을 파일로 저장하여 수동 실행 또는 보관
```

### 진행

```
1. SQL 미리보기 화면에서 [SQL 다운로드] 버튼 클릭
2. create_{법인코드}_db.sql 파일 다운로드
3. SSMS 등에서 수동 실행 또는 문서 보관용으로 활용
```

---

## 시나리오 8: 크로스 서버 복제

### 배경
```
사용자: 시스템 관리자 (admin)
목적: 소스 법인과 다른 서버에 신규 법인 DB 생성 (부하 분산)
```

### 진행

```
1. 참조 법인 선택 → 소스 서버/DB 자동 설정 (예: 운영서버-01)
2. 타겟 서버를 다른 서버로 변경 (예: 운영서버-02)
3. SQL 미리보기 → 실행
4. 크로스 서버 복제 동작
   - _copy_schema_cross_server: 소스에서 컬럼 정보 조회 → 타겟에서 CREATE TABLE
   - _copy_extended_properties_cross_server: 확장 속성 원격 조회 → 타겟에 적용
   - _copy_indexes_cross_server: 인덱스 정보 원격 조회 → 타겟에 생성
   - _copy_data_cross_server: 소스에서 SELECT → 타겟에 INSERT
   - 동일 서버 복제보다 시간 소요 큼

※ 동일 서버 복제 시 (_copy_schema_same_server 등)
   - SELECT TOP 0 INTO, INSERT INTO SELECT 등 서버 내부 명령 사용 (빠름)
```

---

## 처리 단계별 흐름

### 백엔드 실행 순서 (corp_service.create_corp_db_with_sql)

```
STEP 1: 데이터베이스 생성 (사용자 SQL 실행)
  → SqlTemplateService.parse_sql_statements()로 분할 실행
  → 실패 시: 즉시 반환 (DB 미생성이므로 롤백 불필요)

STEP 2: DB 옵션 설정 (운영 표준 자동 적용)
  → _configure_db_options() → SqlTemplateService 위임
  → RECOVERY SIMPLE, Query Store ON, PAGE_VERIFY CHECKSUM 등
  → 실패 시: warnings에 추가 (계속 진행)

STEP 3: 로그인 생성 (master DB에서)
  → CREATE LOGIN [{db_name}_user]
  → 실패 시: _rollback_db() → DB 삭제 + 로그인 삭제

STEP 4: DB 사용자 생성
  → CREATE USER + ALTER ROLE db_owner ADD MEMBER
  → 실패 시: _rollback_db()

STEP 5: 스키마 복제 (테이블 구조)
  → 동일 서버: SELECT TOP 0 INTO 방식
  → 크로스 서버: 컬럼 정보 조회 후 CREATE TABLE 생성
  → 실패 시: _rollback_db()

STEP 5.5: 확장 속성 복제 (컬럼/테이블 설명)
  → 비치명적: 실패해도 계속 진행, warnings에 추가

STEP 6: 인덱스/PK 복제
  → 비치명적: 실패해도 계속 진행

STEP 7: 기초 데이터 복제
  → 비치명적: 실패해도 계속 진행

STEP 8: 관리자 계정 생성 (TB_USER 테이블)
  → admin / Admin@1234 (SHA2_256 해시)
  → 비치명적: 실패해도 계속 진행

STEP 9: 메타 DB 등록 (Corp 테이블)
  → 비치명적: 실패해도 계속 진행

최상위 예외: _rollback_db() + 활동 로그 기록
```

---

## 관련 API

| 메서드 | 경로 | 설명 | 변경 |
|--------|------|------|------|
| GET | `/api/settings/main-db` | 메인 DB 설정 조회 (자동 로드용) | |
| GET | `/api/settings/replication` | 복제 설정 조회 | |
| POST | `/api/corps/fetch-from-main-db` | 메인 DB에서 법인 목록 조회 | |
| GET | `/partials/corps/check-db-exists` | DB 중복 검사 | v1.3.1 추가 |
| POST | `/partials/corps/generate-sql` | 생성 SQL 생성 | request.json() |
| POST | `/partials/corps/execute-sql` | SQL 실행 (키워드 검증 + 에러 매핑) | v1.3.1 보강 |
| POST | `/partials/corps/test-created-db` | 생성된 DB 연결 테스트 | 드라이버 패턴 |

---

## 관련 파일

| 파일 | 경로 | 역할 | v1.3.1 변경 |
|------|------|------|-------------|
| db_create.html | `app/templates/pages/` | 메인 페이지 (단계 표시) | autoLoadMainDbSettings() 추가 |
| step1_corp_select.html | `app/templates/partials/db_create/` | 1단계: 법인 조회/선택 | 타겟 서버 기본 선택 |
| step2_sql_preview.html | `app/templates/partials/db_create/` | 2단계: SQL 편집/실행/결과 | 더블클릭방지, 4컬럼, 중복검사, Jinja분리 |
| partials.py | `app/routers/` | 백엔드 API | check-db-exists, 키워드검증, 에러매핑, 드라이버패턴, SQL로그 |
| corp_service.py | `app/services/` | 비즈니스 로직 | _rollback_db 보강 (로그인 삭제 + 로깅) |
| sql_templates.py | `app/services/` | SQL 템플릿 생성 | |
| activity_service.py | `app/services/` | 활동 로그 서비스 | details 파라미터 활용 |
| settings.py | `app/routers/` | 설정 저장/조회 API | |

---

## 향후 개선 예정

| # | 항목 | 난이도 | 설명 |
|---|------|--------|------|
| 11 | 전역 변수 → 상태 객체 | ⭐⭐⭐ | Alpine.js x-data 또는 네임스페이스로 리팩토링 |
| 12 | 프로그레스 바 (SSE) | ⭐⭐⭐ | 단계별 실시간 진행 상태 (Server-Sent Events) |