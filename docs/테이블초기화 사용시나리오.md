# 테이블 초기화 - 사용 시나리오

> **시스템:** Corp DB Manager v1.1.0  
> **대상 화면:** `/db/table-init`  
> **최종 수정일:** 2026-02-08

---

## 📋 개요

소스 DB의 테이블 데이터를 타겟 DB로 복사하는 기능입니다.
법인코드 자동 치환, TRUNCATE 후 INSERT, Identity 값 유지 등의 옵션을 제공하며, 개별/일괄 실행을 지원합니다.

주요 사용 시나리오:
- 신규 법인 DB 생성 후 기초 데이터 복사
- 운영 DB → 테스트 DB 데이터 이관
- 법인간 기준 데이터 동기화

---

## 🎯 전제 조건

| 항목 | 설명 |
|------|------|
| 소스 DB | 복사 원본이 되는 DB가 존재해야 함 (예: `ACC_UNIES`) |
| 타겟 DB | 데이터를 복사할 대상 DB가 존재해야 함 (예: `ACC_TEST`) |
| 법인 정보 | 메인 DB(COMS_CMPNY)에 소스/타겟 법인 정보가 등록되어야 함 |
| 서버 등록 | 소스/타겟 서버가 시스템에 등록되어야 함 |
| 권한 | `admin` 또는 `operator` 역할 필요 |

---

## 🖥️ 화면 구성

```
┌─────────────────────────────────────────────────────────────┐
│  테이블 초기화                                               │
│  소스 DB의 테이블 데이터를 타겟 DB로 복사합니다               │
├──────────────────────────┬──────────────────────────────────┤
│  소스 (원본 DB)           │  타겟 (대상 DB)                  │
│  서버: [운영서버 ▼]       │  서버: [운영서버 ▼]              │
│  DB:   [ACC_UNIES ▼]     │  DB:   [ACC_TEST ▼]             │
│  ✅ 법인: (주)유니에스     │  ✅ 법인: (주)유니에스(테스트)    │
│         (1000)            │         (9001)                   │
├───────────────────────────┴─────────────────────────────────┤
│  복사 옵션                                                   │
│  ☑ TRUNCATE 후 INSERT  ☑ 법인코드 자동 치환  ☐ Identity 유지 │
├─────────────────────────────────────────────────────────────┤
│  테이블 목록                    [검색...] ☐ 데이터있음 198개  │
│  ☐ 테이블명       | 설명      | 건수  | 법인코드 컬럼 | 상태  │
│  ☐ PCODEMST      | 공통코드  | 1,234 | CORP_CODE ▼  | 대기  │
│  ☐ TAC10         | 전표마스터 |   890 | CORP_CD ▼    | 대기  │
│  ☐ TAC_IIK       | 업무코드  |    45 | 선택... ▼    | 대기  │
│  ...                                                        │
│                                                             │
│  [N개 선택] [선택 INSERT] [선택 DELETE] [해제] [↺ 리셋]       │
└─────────────────────────────────────────────────────────────┘
```

---

## 📝 시나리오 상세

### 1단계: 소스/타겟 DB 선택

**화면:** `/db/table-init` 또는 `/db/table-init/{server_id}`

1. **소스 서버/DB 선택**
   - 소스 서버 드롭다운에서 서버 선택 → DB 목록 자동 로드
   - 소스 DB 선택 → 법인 정보 자동 조회 (메인 DB의 COMS_CMPNY 참조)
   - 법인코드, 법인명이 표시됨 (예: `(주)유니에스 (1000)`)
   - 테이블 목록이 자동으로 로드됨 (테이블명, 설명, 건수, 법인코드 컬럼)

2. **타겟 서버/DB 선택**
   - 타겟 서버 드롭다운에서 서버 선택 → DB 목록 자동 로드
   - 타겟 DB 선택 → 법인 정보 자동 조회
   - 법인코드, 법인명이 표시됨 (예: `(주)유니에스(테스트법인) (9001)`)

3. **검증**
   - 소스와 타겟이 동일한 서버/DB인 경우 → 실행 차단
   - 타겟 DB 미선택 시 → `타겟 DB를 선택해주세요` 알림

4. **URL 파라미터**
   - `/db/table-init/1` 접속 시 소스 서버가 자동 선택됨

---

### 2단계: 복사 옵션 설정

소스/타겟 DB가 모두 선택되면 복사 옵션 패널이 표시됩니다.

| 옵션 | 기본값 | 설명 |
|------|--------|------|
| TRUNCATE 후 INSERT | ☑ ON | 타겟 테이블을 비운 후 INSERT (기존 데이터 삭제) |
| 법인코드 자동 치환 | ☑ ON | 법인코드 컬럼의 값을 소스→타겟 법인코드로 자동 치환 |
| Identity 값 유지 | ☐ OFF | IDENTITY 컬럼의 원본 값을 유지하여 INSERT |

---

### 3단계: 법인코드 컬럼 확인

법인코드 자동 치환 옵션이 ON인 경우, 각 테이블의 법인코드 컬럼을 확인해야 합니다.

1. **자동 감지**
   - 시스템이 CORP_CD, COMPANY_CD, CO_CD, CMPNY_CD, CORP_CODE 등의 컬럼을 자동 감지
   - 감지된 컬럼이 드롭다운에 자동 표시됨

2. **수동 확인 필요**
   - 드롭다운을 클릭하면 해당 테이블의 전체 컬럼 목록이 로드됨
   - `(없음)` 선택 시 → 법인코드 치환 없이 원본 데이터 그대로 복사

3. **미확인 테이블 차단**
   - 법인코드 자동 치환 ON + 소스/타겟 법인코드 모두 존재할 때
   - 드롭다운을 한 번도 클릭하지 않은 테이블은 INSERT/DELETE 실행 차단
   - `드롭다운을 클릭하여 컬럼을 확인해주세요` 안내 표시

---

### 4단계: 개별 INSERT 실행

단일 테이블의 데이터를 소스 → 타겟으로 복사합니다.

1. **INSERT 버튼 클릭**
   - 해당 테이블의 INSERT 버튼 클릭

2. **확인 모달 표시**
   ```
   ┌─────────────────────────────────────────┐
   │  데이터 복사                             │
   │                                         │
   │  테이블: PCODEMST                        │
   │  소스 DB: ACC_UNIES                      │
   │  타겟 DB: ACC_TEST                       │
   │  법인코드: 1000 → 9001                   │
   │  복사 건수: 1,234건                      │
   │                                         │
   │  ⚠️ 기존 데이터가 삭제됩니다 (TRUNCATE)   │
   │                                         │
   │           [취소]  [확인]                  │
   └─────────────────────────────────────────┘
   ```

3. **실행 및 결과**
   - 확인 클릭 → TRUNCATE(옵션) → SELECT(법인코드 치환) → INSERT 순차 실행
   - 결과 모달: ✅ 복사 건수, 치환 건수, 소요시간 표시
   - 테이블 상태 컬럼: `N건 복사` (녹색)

4. **더블클릭 방지**
   - 실행 중 버튼 disabled 처리

---

### 5단계: 개별 DELETE 실행

단일 테이블의 타겟 DB 데이터를 삭제합니다.

1. **DELETE 버튼 클릭**

2. **법인코드 컬럼이 지정된 경우**
   - 해당 법인코드 데이터만 DELETE
   - `DELETE FROM [타겟DB].dbo.[테이블] WHERE [법인코드컬럼] = '9001'`

3. **법인코드 컬럼이 미지정인 경우**
   - ⚠️ `테이블 전체 데이터가 삭제(TRUNCATE)됩니다!` 경고 표시
   - 확인 후 TRUNCATE 실행

4. **결과**
   - 결과 모달: ✅ 삭제 건수, 소요시간 표시
   - 테이블 상태 컬럼: `N건 삭제` (녹색)

---

### 6단계: 일괄 INSERT 실행

여러 테이블을 한 번에 복사합니다.

1. **테이블 선택**
   - 헤더 체크박스: 전체 선택/해제
   - 개별 체크박스: 원하는 테이블만 선택
   - 선택 시 상단에 `N개 선택 | 선택 INSERT | 선택 DELETE | 해제` 표시

2. **선택 INSERT 클릭**
   - 검증: 건수 > 0인 테이블만 필터
   - 검증: 법인코드 컬럼 미확인 테이블 존재 시 → 테이블명 표시 + 차단
   - 건수 = 0 테이블만 선택된 경우 → `데이터가 있는 테이블이 없습니다` 알림

3. **순차 실행 + 프로그레스 바**
   ```
   ┌─────────────────────────────────────────┐
   │  진행 중: 3 / 총 15                      │
   │  ████████░░░░░░░░░░░░  20%              │
   │  현재: TAC10                             │
   └─────────────────────────────────────────┘
   ```
   - 테이블 단위 순차 실행
   - 실행 중 모든 버튼/체크박스 비활성화

4. **완료 알림**
   - `총 15개 테이블: 성공 15개` 알림 모달
   - 각 테이블 상태 컬럼에 `N건 복사` 표시

---

### 7단계: 일괄 DELETE 실행

여러 테이블의 타겟 DB 데이터를 한 번에 삭제합니다.

1. **테이블 선택 후 선택 DELETE 클릭**

2. **커스텀 확인 모달 표시**
   ```
   ┌─────────────────────────────────────────┐
   │  ⚠️ 일괄 삭제 확인                       │
   │                                         │
   │  선택된 5개 테이블의                      │
   │  타겟 DB(ACC_TEST) 데이터를 삭제합니다.   │
   │                                         │
   │           [취소]  [삭제]                  │
   └─────────────────────────────────────────┘
   ```
   - 브라우저 기본 confirm() 대신 커스텀 모달 사용

3. **순차 실행**
   - INSERT와 동일한 프로그레스 바 표시
   - 완료 후 결과 알림

---

### 8단계: 필터 / 검색 / 상태 관리

1. **테이블 검색**
   - 검색창에 키워드 입력 → 테이블명/설명으로 필터링

2. **데이터 있음 필터**
   - `데이터 있음` 체크박스 → 건수 > 0 테이블만 표시
   - 검색과 AND 조건으로 동시 적용 가능

3. **상태 리셋**
   - `↺ 리셋` 버튼 → 모든 테이블 상태를 `대기`로 초기화

4. **선택 해제**
   - `해제` 버튼 → 모든 체크박스 해제

---

## 📊 실행 후 확인 사항

| 확인 항목 | 방법 |
|----------|------|
| 복사 건수 | 결과 모달에서 복사/치환 건수 확인 |
| 법인코드 치환 | 타겟 DB에서 법인코드 컬럼 값이 정상 변경되었는지 확인 |
| 데이터 정합성 | 소스 건수와 타겟 건수가 일치하는지 확인 |
| 에러 테이블 | 상태 컬럼에 `실패`로 표시된 테이블 확인 후 재실행 |

---

## ⚠️ 주의사항

1. **소스/타겟 동일 DB 불가**
   - 동일한 서버 + 동일한 DB를 소스/타겟으로 선택할 수 없음
   - 실수로 운영 DB 데이터를 덮어쓰는 것을 방지

2. **TRUNCATE 옵션 주의**
   - TRUNCATE 옵션 ON 시 타겟 테이블의 기존 데이터가 전부 삭제됨
   - 확인 모달에 경고 메시지 표시
   - 중요 데이터는 사전 백업 필수

3. **법인코드 컬럼 확인 필수**
   - 법인코드 자동 치환 ON 상태에서는 드롭다운을 반드시 클릭하여 컬럼 확인
   - 미확인 시 INSERT/DELETE 실행 차단됨
   - `(없음)` 선택 = 해당 테이블에 법인코드 컬럼 없음을 명시적으로 확인

4. **대량 데이터 주의**
   - 건수가 많은 테이블은 실행 시간이 길어질 수 있음
   - 일괄 실행 시 순차 처리되므로 전체 소요시간 고려
   - 가급적 업무 시간 외 작업 권장

5. **Identity 값 유지 옵션**
   - IDENTITY 컬럼이 있는 테이블에서 원본 값을 유지하고 싶을 때 사용
   - 해당 옵션 OFF 시 타겟 DB가 자동 채번

---

## 📁 에러 메시지 매핑

| 원문 키워드 | 한글 메시지 |
|------------|-----------|
| permission denied | 권한이 없습니다 |
| deadlock | 교착 상태가 발생했습니다. 잠시 후 다시 시도하세요 |
| timeout | 시간 초과. 네트워크 상태를 확인하세요 |
| duplicate key | 중복 키가 존재합니다 |
| foreign key | 외래키 제약조건 위반 |
| truncate | TRUNCATE 권한이 없습니다 |
| connection | 서버 연결에 실패했습니다 |

---

## 🔧 문제 해결

| 문제 | 원인 | 해결 방법 |
|------|------|----------|
| INSERT 실패 | 권한 부족 | 타겟 DB의 INSERT/TRUNCATE 권한 확인 |
| 법인코드 미치환 | 컬럼 미선택 | 드롭다운에서 정확한 법인코드 컬럼 선택 |
| 건수 불일치 | Identity 충돌 | Identity 값 유지 옵션 ON/OFF 확인 |
| 타겟 DB 접속 실패 | 네트워크/계정 | 서버 연결 상태, DB 계정 권한 확인 |
| 테이블 목록 미표시 | 소스 DB 미선택 | 소스 서버 → DB 순서로 선택 |
| 법인 정보 미표시 | 메인 DB 설정 | 시스템 설정에서 메인 DB 서버/DB명 확인 |

---

## 📎 관련 문서

- [신규법인생성_시나리오.md](./신규법인생성_시나리오.md) - 신규 법인 DB 생성 프로세스
- [README.md](../README.md) - 시스템 개요